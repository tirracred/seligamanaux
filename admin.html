<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SeligaManaux</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body class="dark-mode"> <header class="site-header">
        <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
            <div class="logo">
                <a href="/"><h1>SeligaManaux (ADMIN)</h1></a>
            </div>
            <button id="logout-button" style="display: none; background-color: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Sair
            </button>
        </div>
    </header>
    
    <main class="container">

        <form id="login-form" class="admin-form" style="display: block;">
            <h1 class="page-title-admin">Login do Administrador</h1>
            <div id="login-feedback-message" class="message" style="display: none;"></div>
            <div>
                <label for="admin-email">Email</label>
                <input type="email" id="admin-email" required>
            </div>
            <div>
                <label for="admin-password">Senha</label>
                <input type="password" id="admin-password" required>
            </div>
            <button type="submit" id="login-button">ENTRAR</button>
            <p id="loading-login" style="display: none; text-align: center; margin-top: 1rem; color: var(--texto-link);">Entrando...</p>
        </form>

        <div id="admin-panel-container" style="display: none;">

            <section id="scrape-section" class="admin-form">
                <h1 class="page-title-admin" style="margin-top: 0; padding-top: 0;">Buscar Notícias (IA)</h1>
                <p style="color: var(--texto-secundario); margin-bottom: 1.5rem; text-align: center;">
                    Buscar, reescrever e publicar as 5 notícias mais recentes da fonte.
                </p>
                <div class="botoes-scrape" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button type="button" class="scrape-btn" data-source="g1_am">Buscar G1 (AM)</button>
                    <button type="button" class="scrape-btn" data-source="holanda">Buscar P. do Holanda</button>
                    <button type="button" class="scrape-btn" data-source="18horas">Buscar 18 Horas</button>
                    <button type="button" class="scrape-btn" data-source="agencia_am">Buscar Ag. Amazonas</button>
                </div>
                <div id="scrape-message" class="message" style="display: none; margin-top: 1.5rem;"></div>
            </section>
            
            <form id="news-form" class="admin-form">
                <h1 class="page-title-admin">Publicar Notícia Manualmente</h1>
                <div id="feedback-message" class="message" style="display: none;"></div>
                <div>
                    <label for="news-title">Título</label>
                    <input type="text" id="news-title" required>
                </div>
                <div>
                    <label for="news-category">Categoria</label>
                    <select id="news-category" required>
                        <option value="">Selecione...</option>
                        <option value="Manaus e Região">Manaus e Região</option>
                        <option value="Política">Política</option>
                        <option value="Esportes">Esportes</option>
                        <option value="Economia">Economia</option>
                        <option value="Geral">Geral</option>
                    </select>
                </div>
                <div>
                    <label for="news-headline-color">Cor da Manchete</label>
                    <select id="news-headline-color" required>
                        <option value="blue">Azul (Padrão)</option>
                        <option value="red">Vermelho (Destaque)</option>
                    </select>
                </div>
                <div>
                    <label for="news-content">Conteúdo</label>
                    <textarea id="news-content" rows="8" required></textarea>
                </div>
                <div>
                    <label for="news-image">Anexar Foto Principal (Capa)</label>
                    <input type="file" id="news-image" accept="image/*">
                </div>
                <div>
                    <label for="news-gallery">Adicionar Galeria (até 10 mídias)</label>
                    <input type="file" id="news-gallery" accept="image/*,video/*" multiple>
                    <small style="color: var(--texto-secundario); margin-top: 5px; display: block;">
                        Segure Ctrl (ou Cmd) para selecionar múltiplos arquivos.
                    </small>
                </div>
                <button type="submit" id="submit-button">PUBLICAR AGORA</button>
                <p id="loading-submit" style="display: none; text-align: center; margin-top: 1rem; color: var(--texto-link);">Publicando... Aguarde.</p>
            </form>

            <section id="manage-section" class="admin-form">
                 <h1 class="page-title-admin">Gerenciar Notícias</h1>
                 <p id="loading-manage" style="text-align: center; color: var(--texto-secundario);">Carregando notícias...</p>
                 <div id="post-list-container">
                    </div>
            </section>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- REFERÊNCIAS GLOBAIS ---
            const loginForm = document.getElementById('login-form');
            const adminPanel = document.getElementById('admin-panel-container');
            const logoutButton = document.getElementById('logout-button');
            const loginFeedback = document.getElementById('login-feedback-message');
            
            if (!supabase) {
                loginFeedback.innerText = 'Erro fatal: Supabase não inicializado. Verifique main.js';
                loginFeedback.className = 'message error';
                loginFeedback.style.display = 'block';
                return;
            }

            // --- 1. LÓGICA DE AUTENTICAÇÃO (MELHORADA) ---
            
            // Verifica o estado do login QUANDO A PÁGINA CARREGA
            supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    // Usuário ESTÁ logado
                    loginForm.style.display = 'none';
                    adminPanel.style.display = 'block';
                    logoutButton.style.display = 'block';
                    // Carrega os posts gerenciáveis assim que o usuário é confirmado
                    loadManagedPosts();
                } else {
                    // Usuário NÃO está logado
                    loginForm.style.display = 'block';
                    adminPanel.style.display = 'none';
                    logoutButton.style.display = 'none';
                }
            });

            // Evento de submit do Login
            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const loginButton = document.getElementById('login-button');
                const loadingLogin = document.getElementById('loading-login');
                
                loginButton.disabled = true;
                loadingLogin.style.display = 'block';
                loginFeedback.style.display = 'none';

                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;

                try {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    // O onAuthStateChange vai cuidar de mostrar o painel
                } catch (err) {
                    console.error("Erro de login:", err);
                    showLoginMessage(`Erro: ${err.message}`, 'error');
                } finally {
                    loginButton.disabled = false;
                    loadingLogin.style.display = 'none';
                }
            });

            // Evento de clique no Logout
            logoutButton.addEventListener('click', async () => {
                await supabase.auth.signOut();
                // O onAuthStateChange vai cuidar de esconder o painel
            });


          // --- 2. LÓGICA DE SCRAPING (VERSÃO CORRIGIDA) ---
        const scrapeMessage = document.getElementById('scrape-message');
        const scrapeButtons = document.querySelectorAll('.scrape-btn');

        // Mapeia os botões para as URLs reais de scraping
        const sourceMap = {
            "g1_am": "https://g1.globo.com/am/amazonas/",
            "holanda": "https://portaldo-holanda.com.br/amazonas",
            "18horas": "https://www.portalele-18horas.com.br/",
            "agencia_am": "https://www.agenciaamazonas.am.gov.br/"
            // Adicione ou corrija as URLs conforme necessário
        };

        scrapeButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const source = button.dataset.source;
                const urlParaRaspar = sourceMap[source]; // Pega a URL correta

                if (!urlParaRaspar) {
                    scrapeMessage.textContent = `Erro: Fonte '${source}' não definida no sourceMap do admin.html`;
                    scrapeMessage.className = 'message error';
                    scrapeMessage.style.display = 'block';
                    return;
                }

                scrapeButtons.forEach(btn => btn.disabled = true);
                scrapeMessage.textContent = `Buscando notícias de '${source}'... Isso pode levar até 30 segundos.`;
                scrapeMessage.className = 'message';
                scrapeMessage.style.display = 'block';

                try {
                    // Chamando a função com o body correto
                    const { data, error } = await supabase.functions.invoke('scrape-and-rewrite', {
                       body: {
                           url: urlParaRaspar // <-- CORRIGIDO: Enviando a URL dinâmica
                       }
                    })

                    if (error) throw error;
                    
                    // A 'data.message' agora vem da nossa função
                    scrapeMessage.textContent = data.message || 'Sucesso! Notícias publicadas.';
                    scrapeMessage.className = 'message success';
                    
                    // Recarrega a lista de posts para mostrar os novos
                    // que agora estarão visíveis por causa do user_id!
                    await loadManagedPosts();

                } catch (error) {
                    console.error("Erro ao chamar Edge Function:", error);
                    scrapeMessage.textContent = `Erro: ${error.message || 'Falha ao chamar a função.'}`;
                    scrapeMessage.className = 'message error';
                } finally {
                    scrapeButtons.forEach(btn => btn.disabled = false);
                    setTimeout(() => { scrapeMessage.style.display = 'none'; }, 5000);
                }
            });
        });

            
            // --- 3. LÓGICA DE PUBLICAÇÃO MANUAL (O seu código original) ---
            const newsForm = document.getElementById('news-form');
            const submitButton = document.getElementById('submit-button');
            const loadingSubmit = document.getElementById('loading-submit');
            const feedbackMessage = document.getElementById('feedback-message');
            const newsTitle = document.getElementById('news-title');
            const newsCategory = document.getElementById('news-category');
            const newsHeadlineColor = document.getElementById('news-headline-color');
            const newsContent = document.getElementById('news-content');
            const newsImageInput = document.getElementById('news-image');
            const newsGalleryInput = document.getElementById('news-gallery');

            newsForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                submitButton.disabled = true;
                loadingSubmit.style.display = 'block';
                feedbackMessage.style.display = 'none';

                try {
                    // 1. Upload Imagem Principal
                    const mainImageFile = newsImageInput.files[0];
                    let mainImageUrl = null;
                    if (mainImageFile) {
                        mainImageUrl = await uploadMedia(mainImageFile);
                    }

                    // 2. Upload Galeria
                    const galleryFiles = Array.from(newsGalleryInput.files).slice(0, 10);
                    let galleryUrls = [];
                    if (galleryFiles.length > 0) {
                        const uploadPromises = galleryFiles.map(file => uploadMedia(file));
                        galleryUrls = await Promise.all(uploadPromises);
                    }

                    // 3. Monta o objeto
                    const newPost = {
                        title: newsTitle.value,
                        content: newsContent.value,
                        category: newsCategory.value,
                        image_url: mainImageUrl,
                        headline_color: newsHeadlineColor.value,
                        gallery_urls: galleryUrls.length > 0 ? galleryUrls : null
                    };

                    // 4. Insere no DB
                    const { error } = await supabase.from(DB_TABLE).insert(newPost);
                    if (error) throw error;

                    showMessage('Sucesso! Notícia publicada manualmente.', 'success');
                    newsForm.reset();
                    await loadManagedPosts(); // Recarrega a lista

                } catch (err) {
                    console.error("Erro ao publicar:", err);
                    if (err.message.includes("permission denied")) {
                         showMessage('Erro: Permissão negada. Verifique as regras RLS no Supabase.', 'error');
                    } else {
                         showMessage(`Erro: ${err.message}`, 'error');
                    }
                } finally {
                    submitButton.disabled = false;
                    loadingSubmit.style.display = 'none';
                }
            });

            // Função de Upload
            async function uploadMedia(file) {
                if (!file) return null;
                const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                
                const { data, error } = await supabase.storage
                    .from(STORAGE_BUCKET)
                    .upload(fileName, file);

                if (error) throw new Error(`Erro no upload: ${error.message}`);
                
                const { data: publicUrlData } = supabase.storage
                    .from(STORAGE_BUCKET)
                    .getPublicUrl(data.path);
                    
                return publicUrlData.publicUrl;
            }

            
            // --- 4. LÓGICA DE GERENCIAMENTO (O seu código original) ---
            const loadingManage = document.getElementById('loading-manage');
            const postListContainer = document.getElementById('post-list-container');
            
            postListContainer.addEventListener('click', handleDeleteClick);

            async function loadManagedPosts() {
                loadingManage.style.display = 'block';
                postListContainer.innerHTML = '';



                const { data: posts, error } = await supabase
                    .from(DB_TABLE)
                    .select('id, title, created_at')
                    .order('created_at', { ascending: false });
                
                loadingManage.style.display = 'none';

                if (error) {
                    console.error("Erro ao carregar posts:", error);
                    postListContainer.innerHTML = `<p style="color: red; padding: 1rem;">Erro ao carregar posts.</p>`;
                    return;
                }


                if (posts.length === 0) {
                     postListContainer.innerHTML = `<p style="color: var(--texto-secundario); padding: 1rem;">Nenhum post publicado.</p>`;
                     return;
                }

                posts.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'post-item';
                    postEl.innerHTML = `
                        <span>${post.title}</span>
                        <button class="delete-post-btn" data-id="${post.id}">Apagar</button>
                    `;
                    postListContainer.appendChild(postEl);
                });
            }

            async function handleDeleteClick(event) {
                if (!event.target.classList.contains('delete-post-btn')) return;

                const button = event.target;
                const postId = button.dataset.id;
                
                if (!confirm("Tem certeza que deseja apagar este post?")) return;

                button.disabled = true;
                button.innerText = 'Apagando...';

                try {


                    const { error } = await supabase
                        .from(DB_TABLE)
                        .delete()
                        .eq('id', postId);
                    
                    if (error) {


                        if (error.message.includes("permission denied")) {
                            throw new Error("Permissão negada. Verifique as regras RLS (DELETE).");
                        }
                        throw error;
                    }

                    button.closest('.post-item').remove();
                    showMessage('Post apagado com sucesso.', 'success');

                } catch (err) {
                    console.error("Erro ao apagar:", err);
                    showMessage(`Erro ao apagar: ${err.message}`, 'error');
                    button.disabled = false;
                    button.innerText = 'Apagar';
                }
            }

            // --- 5. Funções de Feedback ---
            function showMessage(text, type) {
                feedbackMessage.innerText = text;
                feedbackMessage.className = `message ${type}`;


                feedbackMessage.style.display = 'block';


                setTimeout(() => { feedbackMessage.style.display = 'none'; }, 3000);
            }
            
            function showLoginMessage(text, type) {
                loginFeedback.innerText = text;
                loginFeedback.className = `message ${type}`;
                loginFeedback.style.display = 'block';
            }
        });

        // SCRIPT PARA TESTAR A FUNÇÃO NO ADMIN.HTML
// Adicione este código no seu admin.html dentro de uma tag <script>

async function testarScrapeFuncao() {
  try {
    // 1. Primeiro, obter o token do usuário autenticado
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (sessionError || !session) {
      console.error('Usuário não está autenticado:', sessionError);
      alert('Você precisa estar logado para usar esta função');
      return;
    }

    console.log('Token obtido:', session.access_token);

    // 2. Chamar a Edge Function com o token correto
    const response = await fetch('https://xtnqypmezntjcidglblc.supabase.co/functions/v1/scrape-and-rewrite', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json',
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0bnF5cG1lem50amNpZGdsYmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA2NzMyNTIsImV4cCI6MjA0NjI0OTI1Mn0.VQTr6jYOWmQZvPdZhOqBK0hH7eeZxrMbSTNaDGS_7h8'
      },
      body: JSON.stringify({
        url: 'https://g1.globo.com/am/amazonas/noticia/2025/10/03/alguma-noticia-real.ghtml'
      })
    });

    const data = await response.json();
    console.log('Resposta da função:', data);

    if (response.ok) {
      alert('Sucesso! Notícia processada: ' + data.message);
    } else {
      alert('Erro: ' + (data.error || data.message || 'Erro desconhecido'));
    }

  } catch (error) {
    console.error('Erro na requisição:', error);
    alert('Erro na requisição: ' + error.message);
  }
}

// Para testar, adicione um botão no HTML:
// <button onclick="testarScrapeFuncao()">Testar Scrape G1</button>


   </script>






</body>











</html>



