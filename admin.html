<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - SeligaManaux</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #0b0b0b; color: #fff; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 30px; color: #dc2626; }
    .auth-section, .admin-section, .scraped-section, .api-config { background: #161616; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .scraped-section { border: 2px solid #059669; background:#101922; }
    input, textarea, button, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #333; background: #222; color: #fff; border-radius: 6px; }
    button { background: #dc2626; cursor: pointer; font-weight: bold; border: none; }
    button:hover { background: #b91c1c; }
    .scrape-button { background: #059669; }
    .scrape-button:hover { background: #047857; }
    .publish-button { background: #7c3aed; }
    .publish-button:hover { background: #6d28d9; }
    .danger-button { background: #ef4444; }
    .danger-button:hover { background: #dc2626; }
    .source-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin-bottom: 10px; }
    .hidden { display: none; }
    .loading { text-align: center; color: #bbb; padding: 20px; }
    .noticias-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-top: 16px; }
    .noticia-card { background: #1a1a1a; padding: 14px; border-radius: 8px; border-left: 4px solid #dc2626; }
    .scraped-card { background: #101922; border-left: 4px solid #059669; }
    .noticia-title { font-weight: bold; margin-bottom: 10px; color: #fff; }
    .noticia-content { color: #ccc; margin-bottom: 10px; max-height: 110px; overflow: hidden; }
    .noticia-meta { font-size: 12px; color: #8b8b8b; margin-bottom: 10px; }
    .noticia-actions { display: flex; flex-wrap: wrap; gap: 10px; }
    .noticia-image { width: 100%; max-height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px; }
    .error-message { background: #dc2626; color: white; padding: 15px; border-radius: 6px; margin: 10px 0; }
    .ok-message { background: #065f46; color: white; padding: 15px; border-radius: 6px; margin: 10px 0; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 700px){ .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>SeligaManaux - Admin</h1>

    <div class="api-config">
      <h3>ğŸ”§ ConfiguraÃ§Ã£o do Supabase</h3>
      <div class="row">
        <div>
          <label for="supabaseUrl">Supabase URL</label>
          <input id="supabaseUrl" placeholder="https://SEU_PROJETO.supabase.co">
        </div>
        <div>
          <label for="anonKey">Anon (publishable) Key</label>
          <input id="anonKey" placeholder="Cole a ANON KEY">
        </div>
      </div>
      <button onclick="updateApiConfig()" class="scrape-button">ğŸ’¾ Salvar & Conectar</button>
      <div id="cfgStatus" class="loading hidden"></div>
    </div>

    <div class="auth-section">
      <div id="loginForm">
        <h3>ğŸ” Login</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Senha">
        <button onclick="login()">Entrar</button>
        <p id="loginStatus"></p>
      </div>
      <div id="userInfo" class="hidden">
        <p>UsuÃ¡rio logado: <span id="userEmail"></span></p>
        <button onclick="logout()">Sair</button>
      </div>
    </div>

    <div id="adminPanel" class="hidden">
      <div class="scraped-section">
        <h3>ğŸ¤– Scraper multi-portal</h3>
        <p>Gera matÃ©rias limpas e reescritas (1.800â€“4.000 caracteres) a partir dos portais abaixo.</p>
        <div class="row">
          <div>
            <label for="maxItems">Qtd. por execuÃ§Ã£o (1â€“15)</label>
            <input id="maxItems" type="number" min="1" max="15" value="8">
          </div>
          <div>
            <label for="edgeUrl">Edge Function URL</label>
            <input id="edgeUrl" placeholder="/functions/v1/scraper">
          </div>
        </div>

        <div class="source-buttons">
          <button class="scrape-button" onclick="scrapeById('g1-am', 'G1 Amazonas')">ğŸ“° G1 Amazonas</button>
          <button class="scrape-button" onclick="scrapeById('portaldoholanda', 'Portal do Holanda')">ğŸŒ Portal do Holanda</button>
          <button class="scrape-button" onclick="scrapeById('acritica', 'A CrÃ­tica')">ğŸ“„ A CrÃ­tica</button>
          <button class="scrape-button" onclick="scrapeById('portalamazonia', 'Portal AmazÃ´nia')">ğŸŒ¿ Portal AmazÃ´nia</button>
        </div>

        <div id="scrapeStatus" class="loading hidden">Buscando notÃ­cias... Aguarde.</div>
      </div>

      <div class="admin-section">
        <h3>ğŸ“‹ NotÃ­cias Scraped (pendentes/geradas)</h3>
        <button onclick="loadScrapedNoticias()" class="scrape-button">ğŸ”„ Recarregar</button>
        <div id="scrapedNoticias" class="noticias-container">
          <div class="loading">Carregando...</div>
        </div>
      </div>

      <div class="admin-section">
        <h3>âœï¸ Criar NotÃ­cia Manual</h3>
        <div class="row">
          <div>
            <label for="title">TÃ­tulo</label>
            <input id="title" placeholder="TÃ­tulo da notÃ­cia">
          </div>
          <div>
            <label for="category">Categoria</label>
            <select id="category">
              <option value="Geral">Geral</option>
              <option value="PolÃ­tica">PolÃ­tica</option>
              <option value="Economia">Economia</option>
              <option value="Esportes">Esportes</option>
              <option value="Cultura">Cultura</option>
              <option value="Amazonas">Amazonas</option>
            </select>
          </div>
        </div>
        <label for="content">ConteÃºdo</label>
        <textarea id="content" rows="10" placeholder="ConteÃºdo da notÃ­cia"></textarea>
        <button onclick="publishNoticia()">ğŸ“ Publicar NotÃ­cia</button>
      </div>

      <div class="admin-section">
        <h3>ğŸ“° NotÃ­cias Publicadas</h3>
        <button onclick="loadNoticias()">ğŸ”„ Recarregar</button>
        <div id="noticias" class="noticias-container">
          <div class="loading">Carregando...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== Estado/Auth ========
    let supabaseClient = null;
    let currentSession = null;

    function show(el, yes) { el.classList.toggle('hidden', !yes); }

    function updateApiConfig() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('anonKey').value.trim();
      if (!url || !key) { alert('Informe URL e ANON KEY.'); return; }
      localStorage.setItem('supabase_url', url);
      localStorage.setItem('supabase_anon_key', key);
      initSupabase();
      const cfg = document.getElementById('cfgStatus');
      cfg.textContent = 'âœ… ConfiguraÃ§Ã£o salva.';
      show(cfg, true);
      setTimeout(()=> show(cfg, false), 3000);
    }

    function initSupabase() {
      const savedUrl = localStorage.getItem('supabase_url') || '';
      const savedKey = localStorage.getItem('supabase_anon_key') || '';
      if (!savedUrl || !savedKey) return;
      const { createClient } = supabase;
      supabaseClient = createClient(savedUrl, savedKey, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } });
      supabaseClient.auth.onAuthStateChange((event, session) => {
        currentSession = session;
        if (session) {
          document.getElementById('userEmail').textContent = session.user.email;
        }
        show(document.getElementById('loginForm'), !session);
        show(document.getElementById('userInfo'), !!session);
        show(document.getElementById('adminPanel'), !!session);
        if (session) { loadScrapedNoticias(); loadNoticias(); }
      });
    }

    async function login() {
      if (!supabaseClient) return alert('Configure o Supabase primeiro.');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const statusEl = document.getElementById('loginStatus');
      statusEl.textContent = 'Entrando...';
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        statusEl.textContent = 'âœ… Login OK';
      } catch (e) {
        statusEl.textContent = 'âŒ ' + (e.message || e);
      }
    }

    async function logout() {
      if (!supabaseClient) return;
      await supabaseClient.auth.signOut();
    }

    // ======== Scraper Trigger ========
    async function scrapeById(portalId, label) {
      if (!supabaseClient || !currentSession) return alert('FaÃ§a login primeiro.');
      const edgeUrl = (document.getElementById('edgeUrl').value.trim() || '/functions/v1/scraper');
      const max = Math.min(Math.max(parseInt(document.getElementById('maxItems').value || '8', 10), 1), 15);
      const statusEl = document.getElementById('scrapeStatus');
      statusEl.textContent = `Processando ${label}...`;
      show(statusEl, true);
      try {
        const anonKey = localStorage.getItem('supabase_anon_key') || '';
        const res = await fetch(edgeUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentSession.access_token}`,
            'Content-Type': 'application/json',
            'apikey': anonKey
          },
          body: JSON.stringify({ portalId, max })
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        statusEl.textContent = `âœ… ${label}: ${data.processed || 0} processadas, ${data.inserted || 0} salvas.`;
        setTimeout(()=> show(statusEl, false), 4000);
        loadScrapedNoticias();
      } catch (e) {
        statusEl.textContent = 'âŒ ' + (e.message || e);
        setTimeout(()=> show(statusEl, false), 5000);
      }
    }

    // ======== Scraped ========
    async function loadScrapedNoticias() {
      const container = document.getElementById('scrapedNoticias');
      container.innerHTML = '<div class="loading">Carregando...</div>';
      if (!supabaseClient) return;
      const { data, error } = await supabaseClient
        .from('noticias_scraped')
        .select('*')
        .in('status', ['gerado','aprovado'])
        .order('data_coleta', { ascending: false })
        .limit(30);
      if (error) {
        container.innerHTML = `<div class="error-message">Erro: ${error.message}</div>`;
        return;
      }
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="ok-message">Sem pendÃªncias. Dispare o scraper acima.</div>';
        return;
      }
      container.innerHTML = data.map(n => {
        const img = n.imagem_url ? `<img src="${n.imagem_url}" class="noticia-image" onerror="this.style.display='none'">` : '';
        const len = (n.conteudo_reescrito || '').length;
        return `
          <div class="noticia-card scraped-card">
            ${img}
            <div class="noticia-title">${(n.titulo_reescrito || n.titulo_original || '(sem tÃ­tulo)')}</div>
            <div class="noticia-content">${(n.conteudo_reescrito || '').substring(0, 300)}...</div>
            <div class="noticia-meta">
              <strong>Fonte:</strong> ${n.fonte || '-'} â€¢ <strong>Categoria:</strong> ${n.categoria || '-'}
              <br><strong>Tamanho:</strong> ${len} chars â€¢ <strong>Status:</strong> ${n.status}
              <br>${n.url_original ? `<a href="${n.url_original}" target="_blank" style="color:#34d399">Original</a>` : ''}
            </div>
            <div class="noticia-actions">
              <button onclick="copyToClipboard(${JSON.stringify(n.titulo_reescrito || '').replace(/"/g,'&quot;')})">Copiar tÃ­tulo</button>
              <button onclick="copyToClipboard(${JSON.stringify(n.conteudo_reescrito || '').replace(/"/g,'&quot;')})">Copiar conteÃºdo</button>
              <button class="scrape-button" onclick="setStatus(${n.id}, 'aprovado')">Aprovar</button>
              <button class="publish-button" onclick="publishScraped(${n.id})">Publicar</button>
              <button class="danger-button" onclick="deleteScraped(${n.id})">Excluir</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function setStatus(id, status) {
      if (!supabaseClient) return;
      const patch = { status };
      if (status === 'publicado') patch['data_publicacao'] = new Date().toISOString();
      const { error } = await supabaseClient.from('noticias_scraped').update(patch).eq('id', id);
      if (error) return alert('Erro: ' + error.message);
      loadScrapedNoticias();
    }

    async function publishScraped(scrapedId) {
      if (!confirm('Publicar esta notÃ­cia?')) return;
      const { data: s, error: e1 } = await supabaseClient.from('noticias_scraped').select('*').eq('id', scrapedId).single();
      if (e1) return alert('Erro: ' + e1.message);
      const content = s.conteudo_reescrito || '';
      const { error: e2 } = await supabaseClient.from('noticias').insert({
        title: s.titulo_reescrito || s.titulo_original,
        content,
        category: s.categoria || 'Geral',
        image_url: s.imagem_url
      });
      if (e2) return alert('Erro: ' + e2.message);
      await setStatus(scrapedId, 'publicado');
      loadNoticias();
    }

    async function deleteScraped(id) {
      if (!confirm('Excluir esta notÃ­cia?')) return;
      const { error } = await supabaseClient.from('noticias_scraped').delete().eq('id', id);
      if (error) return alert('Erro: ' + error.message);
      loadScrapedNoticias();
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text || '').then(()=> alert('Copiado!'), ()=> alert('Falha ao copiar.'));
    }

    // ======== Publicadas ========
    async function loadNoticias() {
      const container = document.getElementById('noticias');
      container.innerHTML = '<div class="loading">Carregando...</div>';
      if (!supabaseClient) return;
      const { data, error } = await supabaseClient.from('noticias').select('*').order('created_at', { ascending: false }).limit(30);
      if (error) {
        container.innerHTML = `<div class="error-message">Erro: ${error.message}</div>`;
        return;
      }
      if (!data || data.length === 0) { container.innerHTML = '<div class="ok-message">Sem notÃ­cias publicadas.</div>'; return; }
      container.innerHTML = data.map(n => {
        const img = n.image_url ? `<img src="${n.image_url}" class="noticia-image" onerror="this.style.display='none'">` : '';
        const created = n.created_at ? new Date(n.created_at).toLocaleString('pt-BR') : '-';
        return `
          <div class="noticia-card">
            ${img}
            <div class="noticia-title">${n.title || '(sem tÃ­tulo)'}</div>
            <div class="noticia-content">${(n.content || '').substring(0, 300)}...</div>
            <div class="noticia-meta">
              <strong>Categoria:</strong> ${n.category || '-'} â€¢ <strong>Publicado:</strong> ${created}
            </div>
            <div class="noticia-actions">
              <button class="danger-button" onclick="deleteNoticia(${n.id})">Excluir</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function deleteNoticia(id) {
      if (!confirm('Excluir definitivamente?')) return;
      const { error } = await supabaseClient.from('noticias').delete().eq('id', id);
      if (error) return alert('Erro: ' + error.message);
      loadNoticias();
    }

    // ======== Boot ========
    window.addEventListener('DOMContentLoaded', () => {
      // carregar config armazenada
      document.getElementById('supabaseUrl').value = localStorage.getItem('supabase_url') || '';
      document.getElementById('anonKey').value = localStorage.getItem('supabase_anon_key') || '';
      document.getElementById('edgeUrl').value = localStorage.getItem('edge_url') || '/functions/v1/scraper';
      initSupabase();
    });
    // persist edge url
    document.getElementById('edgeUrl').addEventListener('change', (e)=> localStorage.setItem('edge_url', e.target.value));
  </script>
</body>
</html>