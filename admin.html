<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SeligaManaux</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS ORIGINAL (TEMA ESCURO) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; color: #dc2626; }
        h2 { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #404040; }
        h3 { font-size: 1.25rem; margin-bottom: 15px; color: #fff; }
        
        .auth-section { background: #262626; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .admin-section { background: #262626; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .scraped-section { background: #1f2937; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #059669; }
        
        input, textarea, button, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #404040;
            background: #333;
            color: #fff;
            border-radius: 4px;
            font-size: 1rem;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3);
        }

        button { background: #dc2626; cursor: pointer; font-weight: bold; }
        button:hover { background: #b91c1c; }
        
        .btn-primary { background: #7c3aed; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-success { background: #059669; }
        .btn-success:hover { background: #047857; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: #1f2937; }
        .btn-warning:hover { background: #d97706; }

        .scrape-button { background: #059669; }
        .scrape-button:hover { background: #047857; }
        .publish-button { background: #7c3aed; }
        .publish-button:hover { background: #6d28d9; }
        .danger-button { background: #ef4444; }
        .danger-button:hover { background: #dc2626; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        small { color: #9ca3af; margin-top: -5px; display: block; }

        .noticias-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .noticia-card { background: #333; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626; display: flex; flex-direction: column; }
        .scraped-card { background: #1f2937; border-left: 4px solid #059669; }
        
        .noticia-image { width: 100%; height: 160px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background-color: #4b5563; }
        .noticia-image[src=""] { display: none; }
        
        .noticia-card-content { padding-top: 10px; flex-grow: 1; }
        .noticia-title { font-weight: bold; margin-bottom: 10px; color: #fff; font-size: 1.1rem; }
        .noticia-content { color: #ccc; margin-bottom: 10px; max-height: 100px; overflow: hidden; font-size: 0.9rem; }
        .noticia-meta { font-size: 12px; color: #888; margin-bottom: 10px; }
        .noticia-actions { display: flex; gap: 10px; margin-top: auto; }
        .noticia-actions button { width: auto; padding: 8px 16px; margin: 0; font-size: 0.9rem; }
        
        .hidden { display: none; }
        .loading { text-align: center; color: #888; padding: 20px; }
        .source-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .source-buttons button { margin: 0; }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-pendente { background: #f59e0b; color: #1f2937; }
        .status-publicado { background: #7c3aed; color: white; }
        
        .message { padding: 15px; border-radius: 6px; margin: 15px 0; font-weight: 600; }
        .message.error { background: #991b1b; color: #fee2e2; }
        .message.warning { background: #fde68a; color: #78350f; }
        .message.success { background: #166534; color: #dcfce7; }
        
        .api-config { display: none !important; }

        /* ESTILOS DO MODAL (NOVOS) */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #262626;
            border: 1px solid #404040;
            margin: auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-button {
            color: #888;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover { color: #fff; }

        .modal-actions {
            border-top: 1px solid #404040;
            padding-top: 20px;
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-actions button { margin: 0; }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        #editImagePreview {
            width: 100%;
            max-width: 400px;
            border-radius: 6px;
            border: 1px solid #404040;
            margin-top: 10px;
            background-color: #333;
        }
        #editImagePreview:not([src]) { display: none; }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .modal-content { padding: 20px; width: 95%; }
            .close-button { right: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SeligaManaux - Admin</h1>

        <div class="auth-section">
            <div id="loginForm">
                <h3>Login</h3>
                <input type="email" id="email" placeholder="Email" value="tirra@tirracred.com.br">
                <input type="password" id="password" placeholder="Senha" required>
                <button onclick="login()">Entrar</button>
                <p id="loginStatus"></p>
            </div>
            <div id="userInfo" class="hidden">
                <p>Usu√°rio logado: <span id="userEmail"></span></p>
                <button onclick="logout()" class="btn-secondary">Sair</button>
            </div>
        </div>

        <div id="adminPanel" class="hidden">
            
            <div class="scraped-section">
                <h2>ü§ñ Buscar Not√≠cias Autom√°ticas</h2>
                <p>Buscar, reescrever e salvar not√≠cias dos principais portais de Manaus/Amazonas.</p>
                
             <div class="source-buttons">
                <button class="scrape-button" onclick="scrapePortal('https://g1.globo.com/am/amazonas/', 'G1 Amazonas', { sourceKey:'g1' })">üì∞ G1 Amazonas</button>
                <button class="scrape-button" onclick="scrapePortal('https://g1.globo.com/am/amazonas/cidade/manaus/', 'G1 Manaus', { sourceKey:'g1-manaus' })">üèôÔ∏è G1 Manaus</button>
                <button class="scrape-button" onclick="scrapePortal('https://www.portaldoholanda.com.br/amazonas', 'Portal do Holanda', { sourceKey:'holanda' })">üåê Portal do Holanda</button>
                <button class="scrape-button" onclick="scrapePortal('https://portalamazonia.com/', 'Portal Amaz√¥nia', { sourceKey:'amazonia' })">üåø Portal Amaz√¥nia</button>
                <button class="scrape-button" onclick="scrapePortal('https://d24am.com/', 'D24AM', { sourceKey:'d24am' })">üóûÔ∏è D24AM</button>
            </div>

                <div id="scrapeControls" class="form-group" style="margin-top:10px">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="rodadas">Rodadas por portal:</label>
                            <input type="number" id="rodadas" min="1" max="10" value="3">
                        </div>
                        <div class="form-group">
                            <label for="limitePorPortal">M√°ximo de artigos por portal (por rodada):</label>
                            <input type="number" id="limitePorPortal" min="1" max="15" value="6">
                        </div>
                         <div class="form-group">
                            <label for="paginateEnd">Paginar at√© a p√°gina:</label>
                            <input type="number" id="paginateEnd" min="1" max="6" value="4">
                        </div>
                        <div class="form-group">
                            <label for="minLen">Tamanho m√≠nimo (reescrita):</label>
                            <input type="number" id="minLen" min="1000" max="6000" value="2000">
                        </div>
                    </div>
                    
                    <label style="display:flex;align-items:center;gap:8px;margin-top:6px">
                    <input type="checkbox" id="ampPreferred" checked style="width: auto; margin: 0;">
                    Preferir vers√£o AMP quando dispon√≠vel (G1, etc.)
                    </label>

                    <label for="customUrl" style="margin-top: 15px;">Ou buscar por uma URL de listagem espec√≠fica:</label>
                    <input type="url" id="customUrl" placeholder="Cole aqui uma URL de listagem (ex.: https://www.portaldoholanda.com.br/amazonas?page=2)">
                    <button class="btn-secondary" onclick="scrapeCustom()" style="margin: 0;">üîé Buscar pela URL informada</button>


                    <div class="source-buttons" style="margin-top:20px">
                    <button class="btn-primary" onclick="scrapeAll()" style="padding: 15px;">üöÄ Buscar de todos os portais (auto)</button>
                    </div>
                </div>

                <div id="scrapeStatus" class="loading hidden">Buscando not√≠cias... Aguarde.</div>
            </div>

            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h2>üìã Not√≠cias Pendentes (Scraped)</h2>
                    <button onclick="loadScrapedNoticias()" class="btn-success">üîÑ Recarregar Pendentes</button>
                </div>
                <p>Not√≠cias coletadas automaticamente que est√£o aguardando sua revis√£o e publica√ß√£o.</p>
                <div id="scrapedNoticias" class="noticias-container">
                    <div class="loading">Carregando not√≠cias scraped...</div>
                </div>
            </div>

            <div class="admin-section">
                 <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h2>üì∞ Not√≠cias Publicadas (e Agendadas)</h2>
                    <div>
                        <button onclick="openEditModal(null)" class="btn-primary">‚úçÔ∏è Criar Nova Not√≠cia</button>
                        <button onclick="loadNoticias()" class="btn-secondary">üîÑ Recarregar Publicadas</button>
                    </div>
                </div>
                <p>Not√≠cias que j√° est√£o no ar ou agendadas para publica√ß√£o.</p>
                <div id="noticias" class="noticias-container">
                    <div class="loading">Carregando not√≠cias publicadas...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2 id="modalTitle">Criar/Editar Not√≠cia</h2>
            
            <input type="hidden" id="editId">
            <input type="hidden" id="editSourceTable">

            <div class="form-group">
                <label for="editTitle">T√≠tulo:</label>
                <input type="text" id="editTitle" placeholder="T√≠tulo da not√≠cia">
            </div>

            <div class="form-group">
                <label for="editContent">Conte√∫do (HTML permitido):</label>
                <textarea id="editContent" rows="12" placeholder="Comece a escrever..."></textarea>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label for="editCategory">Categoria:</label>
                    <select id="editCategory">
                        <option value="Geral">Geral</option>
                        <option value="Amazonas">Amazonas</option>
                        <option value="Manaus e Regi√£o">Manaus e Regi√£o</option>
                        <option value="Pol√≠tica">Pol√≠tica</option>
                        <option value="Economia">Economia</option>
                        <option value="Esportes">Esportes</option>
                        <option value="Cultura">Cultura</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editHeadlineColor">Cor da Manchete:</label>
                    <select id="editHeadlineColor">
                        <option value="blue">Azul (Padr√£o)</option>
                        <option value="red">Vermelho (Destaque)</option>
                    </select>
                </div>
            </div>

            <h3 style="margin-top: 10px;">Gerenciar Imagem</h3>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="editImageUpload">Fazer Upload (Storage):</label>
                    <input type="file" id="editImageUpload" onchange="handleImageUpload(event)" accept="image/*">
                    <small id="uploadStatus"></small>
                </div>
                <div class="form-group">
                    <label for="editImageUrl">Ou Colar URL da Imagem:</label>
                    <input type="text" id="editImageUrl" oninput="updateImagePreview()" placeholder="https://exemplo.com/imagem.jpg">
                </div>
            </div>

            <div class="form-group">
                <label>Preview:</label>
                <img id="editImagePreview" src="" alt="Preview da imagem">
            </div>

            <h3 style="margin-top: 10px;">Publica√ß√£o</h3>
            <div class="message warning" style="background: #4b3200; color: #fef3c7; border: 1px solid #78350f;">
                <strong>Aten√ß√£o:</strong> Para o agendamento funcionar, sua tabela "noticias" precisa da coluna `publish_at` (do tipo `timestamp`) e seu site (index.html, etc) precisa filtrar por ela.
            </div>
            
            <div class="form-group">
                <label for="editPublishAt">Agendar para:</label>
                <input type="datetime-local" id="editPublishAt">
                <small>Deixe em branco para publicar imediatamente ou salvar como rascunho.</small>
            </div>
            
            <div class="modal-actions">
                <button class="btn-secondary" onclick="saveNoticia('draft')">üíæ Salvar Rascunho</button>
                <button class="btn-primary" onclick="saveNoticia('schedule')">üóìÔ∏è Agendar</button>
                <button class="btn-success" onclick="saveNoticia('publish_now')">üöÄ Publicar Agora</button>
            </div>
        </div>
    </div>


    <script>
        // Vari√°veis globais
        let supabaseClient = null;
        let currentSession = null;
        
        // Nomes das tabelas e bucket
        const DB_TABLE_PUBLISHED = 'noticias';
        const DB_TABLE_SCRAPED = 'noticias_scraped';
        const STORAGE_BUCKET = 'midia';

        // Portais padronizados
        const PORTAIS = [
            { key: 'g1',        name: 'G1 Amazonas',  url: 'https://g1.globo.com/am/amazonas/' },
            { key: 'g1-manaus', name: 'G1 Manaus',    url: 'https://g1.globo.com/am/amazonas/cidade/manaus/' },
            { key: 'holanda',   name: 'Portal do Holanda', url: 'https://www.portaldoholanda.com.br/amazonas' },
            { key: 'amazonia',  name: 'Portal Amaz√¥nia',   url: 'https://portalamazonia.com/' },
            { key: 'd24am',     name: 'D24AM',             url: 'https://d24am.com/' },
            { key: 'acritica',  name: 'A Cr√≠tica',         url: 'https://www.acritica.com/' },
        ];


        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        
        // -------------------------------------------------------------------
        // INICIALIZA√á√ÉO E AUTENTICA√á√ÉO (COM A CORRE√á√ÉO)
        // -------------------------------------------------------------------

        function initSupabase() {
            const savedUrl = localStorage.getItem('supabase_url') || 'https://xtnqypmezntjcidglblc.supabase.co';
            const savedKey = localStorage.getItem('supabase_anon_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0bnF5cG1lem50amNpZGdsYmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5ODEwMDksImV4cCI6MjA3NzU1NzAwOX0.fz__YKaMuEWjoXVansGZnLgUhsdsg7J1tLCriMhV8Ls';

            // O campo 'anonKey' do HTML n√£o existe mais, ent√£o removemos a linha
            // document.getElementById('anonKey').value = savedKey;
                
            try {
                // *** A CORRE√á√ÉO CR√çTICA EST√Å AQUI ***
                // Usamos 'window.supabase' para garantir que estamos acessando
                // o objeto da biblioteca Supabase carregada pela tag <script>
                if (window.supabase) {
                    const { createClient } = window.supabase; 
                    supabaseClient = createClient(savedUrl, savedKey, {
                        auth: {
                            persistSession: true,
                            autoRefreshToken: true,
                            detectSessionInUrl: true
                        }
                    });

                    console.log('Supabase inicializado com sucesso.');
                    
                    // Verifica se j√° est√° logado
                    supabaseClient.auth.onAuthStateChange((event, session) => {
                        console.log('Auth state changed:', event, session?.user?.email || 'No user');
                        
                        if (session) {
                            currentSession = session;
                            document.getElementById('loginForm').classList.add('hidden');
                            document.getElementById('userInfo').classList.remove('hidden');
                            document.getElementById('adminPanel').classList.remove('hidden');
                            document.getElementById('userEmail').textContent = session.user.email;
                            loadScrapedNoticias();
                            loadNoticias();
                        } else {
                            currentSession = null;
                            document.getElementById('loginForm').classList.remove('hidden');
                            document.getElementById('userInfo').classList.add('hidden');
                            document.getElementById('adminPanel').classList.add('hidden');
                        }
                    });
                } else {
                    console.error('Falha ao carregar a biblioteca Supabase (window.supabase n√£o existe). Verifique a tag <script> da CDN.');
                    alert('Erro fatal: A biblioteca Supabase n√£o foi carregada.');
                }
                    
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                alert('Erro fatal ao inicializar o Supabase. Verifique o console.');
            }
        }

        async function login() {
            if (!supabaseClient) {
                alert('‚ö†Ô∏è Erro: Cliente Supabase n√£o foi inicializado.'); 
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('loginStatus');
            statusEl.textContent = 'Autenticando...';
            statusEl.style.color = '#888';

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentSession = data.session;
                statusEl.textContent = 'Login realizado com sucesso!';
                statusEl.style.color = 'green';

            } catch (error) {
                statusEl.textContent = 'Erro: ' + error.message;
                statusEl.style.color = 'red';
                console.error('Erro de login:', error);
            }
        }

        async function logout() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentSession = null;
            document.getElementById('loginStatus').textContent = '';
        }
        
        // -------------------------------------------------------------------
        // L√ìGICA DE SCRAPE
        // -------------------------------------------------------------------

       async function scrapeAll() {
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            const rounds = parseInt(document.getElementById('rodadas')?.value || '1', 10);
            const limit  = parseInt(document.getElementById('limitePorPortal')?.value || '6', 10);
            
            const statusEl = document.getElementById('scrapeStatus');
            statusEl.classList.remove('hidden');
            statusEl.className = 'message success';
            statusEl.style.color = '#dcfce7'; // Corrigindo cor do texto

            for (let r = 1; r <= rounds; r++) {
                for (const p of PORTAIS) {
                statusEl.textContent = `Rodada ${r}/${rounds} ‚Äî buscando ${p.name}...`;
                await scrapePortal(p.url, p.name, { sourceKey: p.key, limit });
                await sleep(1200);
                }
            }

            statusEl.textContent = '‚úÖ Finalizado. Recarregando pendentes...';
            setTimeout(() => statusEl.classList.add('hidden'), 4000);
            await loadScrapedNoticias();
        }

       async function scrapePortal(url, sourceName, opts = {}) {
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }

            const statusEl = document.getElementById('scrapeStatus');
            statusEl.classList.remove('hidden');
            statusEl.className = 'message';
            statusEl.textContent = `Buscando not√≠cias do ${sourceName}... Aguarde.`;

            try {
                // Pega a anonKey do cliente Supabase j√° inicializado
                const anonKey = supabaseClient.options.global.headers.apikey;

                const limit    = opts.limit ?? parseInt(document.getElementById('limitePorPortal')?.value || '6', 10);
                const endPage  = parseInt(document.getElementById('paginateEnd')?.value || '1', 10);
                const minLen   = parseInt(document.getElementById('minLen')?.value || '2000', 10);
                const ampPref  = document.getElementById('ampPreferred')?.checked ?? true;

                const response = await fetch('https://xtnqypmezntjcidglblc.supabase.co/functions/v1/scrape-and-rewrite', {
                method: 'POST',
                mode: 'cors',
                credentials: 'omit',
                headers: {
                    'Authorization': `Bearer ${currentSession.access_token}`,
                    'Content-Type': 'application/json',
                    'apikey': anonKey
                },
                body: JSON.stringify({
                    url,
                    sourceName,
                    sourceKey: opts.sourceKey || null,
                    limit,
                    paginate: { start: 1, end: endPage },
                    ampPreferred: ampPref,
                    requireLength: { min: minLen },
                })
                });

                const data = await response.json();

                if (response.ok) {
                    const ok = data.stats?.processadas_com_sucesso ?? data.processed ?? 0;
                    const found = data.stats?.total_encontradas ?? 'N/A';
                    statusEl.textContent = `‚úÖ ${sourceName}: ${ok} not√≠cias processadas.`;
                    statusEl.className = 'message success';
                } else {
                    statusEl.textContent = `‚ùå ${sourceName}: ${data.error || data.message || 'Erro desconhecido'}`;
                    statusEl.className = 'message error';
                    console.error('Erro da API:', data);
                }
            } catch (error) {
                statusEl.textContent = `‚ùå Erro na requisi√ß√£o: ${error.message}`;
                statusEl.className = 'message error';
                console.error('Erro:', error);
            }

            setTimeout(() => statusEl.classList.add('hidden'), 6000);
        }

        async function scrapeCustom() {
            const u = document.getElementById('customUrl')?.value?.trim();
            if (!u) { alert('Informe uma URL.'); return; }
            let name = 'URL Customizada';
            try {
                name = new URL(u).hostname.replace('www.', '');
            } catch {}
            await scrapePortal(u, name, { sourceKey: 'custom' });
        }
        
        // -------------------------------------------------------------------
        // CARREGAR NOT√çCIAS (HTML Alterado para o Modal)
        // -------------------------------------------------------------------

        async function loadScrapedNoticias() {
            const container = document.getElementById('scrapedNoticias');
            container.innerHTML = '<div class="loading">Carregando not√≠cias scraped...</div>';

            if (!supabaseClient) {
                container.innerHTML = '<div class="error-message">‚ùå Supabase n√£o configurado.</div>';
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from(DB_TABLE_SCRAPED)
                    .select('*')
                    .eq('status', 'pendente')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="loading">‚úÖ Nenhuma not√≠cia scraped pendente.</div>';
                    return;
                }

                container.innerHTML = data.map(noticia => {
                    const dataTexto = new Date(noticia.data_coleta || noticia.created_at).toLocaleString('pt-BR');
                    return `
                        <div class="noticia-card scraped-card">
                            <img src="${noticia.imagem_url || ''}" alt="" class="noticia-image" onerror="this.style.display='none'">
                            <div class="noticia-card-content">
                                <div class="noticia-title">${noticia.titulo_reescrito || 'Sem t√≠tulo'}</div>
                                <div class="noticia-content">${(noticia.resumo_reescrito || 'Sem resumo').substring(0, 150)}...</div>
                                <div class="noticia-meta">
                                    <span class="status-badge status-pendente">Pendente</span><br>
                                    <strong>Fonte:</strong> ${noticia.fonte || 'N/A'}<br>
                                    <strong>Categoria:</strong> ${noticia.categoria || 'Geral'}<br>
                                    <strong>Coletado:</strong> ${dataTexto}
                                </div>
                            </div>
                            <div class="noticia-actions">
                                <button class="btn-primary" onclick="openEditModal(${noticia.id}, '${DB_TABLE_SCRAPED}')">‚úèÔ∏è Editar e Publicar</button>
                                <button class="btn-danger" onclick="deleteScrapedNoticia(${noticia.id})">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar not√≠cias scraped:', error);
                container.innerHTML = `<div class="error-message">‚ùå Erro ao carregar: ${error.message}</div>`;
            }
        }

        async function loadNoticias() {
            const container = document.getElementById('noticias');
            container.innerHTML = '<div class="loading">Carregando not√≠cias publicadas...</div>';

            if (!supabaseClient) {
                container.innerHTML = '<div class="error-message">‚ùå Supabase n√£o configurado.</div>';
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from(DB_TABLE_PUBLISHED)
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="loading">‚úÖ Nenhuma not√≠cia publicada encontrada.</div>';
                    return;
                }

                container.innerHTML = data.map(noticia => {
                    const dataTexto = new Date(noticia.created_at).toLocaleString('pt-BR');
                    let statusHtml = '';
                    
                    if (noticia.publish_at) {
                        if (new Date(noticia.publish_at) > new Date()) {
                            statusHtml = `<span class="status-badge status-pendente">Agendado para ${new Date(noticia.publish_at).toLocaleString('pt-BR')}</span><br>`;
                        } else {
                            statusHtml = `<span class="status-badge status-publicado">Publicado</span><br>`;
                        }
                    } else if (noticia.publish_at === null) {
                         statusHtml = `<span class="status-badge" style="background: #ccc; color: #333;">Rascunho</span><br>`;
                    } else {
                        statusHtml = `<span class="status-badge status-publicado">Publicado</span><br>`;
                    }

                    return `
                        <div class="noticia-card">
                            <img src="${noticia.image_url || ''}" alt="" class="noticia-image" onerror="this.style.display='none'">
                            <div class="noticia-card-content">
                                <div class="noticia-title">${noticia.title || 'Sem t√≠tulo'}</div>
                                <div class="noticia-content">${(noticia.content || 'Sem conte√∫do').replace(/<[^>]+>/g, "").substring(0, 150)}...</div>
                                <div class="noticia-meta">
                                    ${statusHtml}
                                    <strong>Categoria:</strong> ${noticia.category || 'N/A'}<br>
                                    <strong>Criado em:</strong> ${dataTexto}
                                </div>
                            </div>
                            <div class="noticia-actions">
                                <button class="btn-primary" onclick="openEditModal(${noticia.id}, '${DB_TABLE_PUBLISHED}')">‚úèÔ∏è Editar</button>
                                <button class="btn-danger" onclick="deleteNoticia(${noticia.id})">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar not√≠cias publicadas:', error);
                container.innerHTML = `<div class="error-message">‚ùå Erro ao carregar: ${error.message}</div>`;
            }
        }
        
        // -------------------------------------------------------------------
        // L√ìGICA DO MODAL DE EDI√á√ÉO (NOVA)
        // -------------------------------------------------------------------

        function resetModal() {
            document.getElementById('modalTitle').textContent = 'Criar Nova Not√≠cia';
            document.getElementById('editId').value = '';
            document.getElementById('editSourceTable').value = '';
            document.getElementById('editTitle').value = '';
            document.getElementById('editContent').value = '';
            document.getElementById('editCategory').value = 'Geral';
            document.getElementById('editHeadlineColor').value = 'blue';
            document.getElementById('editImageUrl').value = '';
            document.getElementById('editImageUpload').value = '';
            document.getElementById('editImagePreview').src = '';
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editPublishAt').value = '';
            document.getElementById('uploadStatus').textContent = '';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            resetModal();
        }

        async function openEditModal(id, sourceTable) {
            resetModal();
            
            if (!id) {
                // √â uma not√≠cia manual nova
                document.getElementById('modalTitle').textContent = 'Criar Nova Not√≠cia';
                document.getElementById('editSourceTable').value = DB_TABLE_PUBLISHED; // Novas sempre v√£o para a tabela publicada
                document.getElementById('editModal').classList.remove('hidden');
            } else {
                // √â uma edi√ß√£o (scraped ou published)
                document.getElementById('modalTitle').textContent = 'Editar Not√≠cia';
                document.getElementById('editId').value = id;
                document.getElementById('editSourceTable').value = sourceTable;

                try {
                    const { data, error } = await supabaseClient
                        .from(sourceTable)
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (error) throw error;
                    
                    // Preenche o formul√°rio
                    document.getElementById('editTitle').value = data.title || data.titulo_reescrito || data.titulo_original || '';
                    document.getElementById('editContent').value = data.content || data.conteudo_reescrito || data.resumo_reescrito || '';
                    document.getElementById('editCategory').value = data.category || 'Geral';
                    document.getElementById('editHeadlineColor').value = data.headline_color || 'blue';
                    document.getElementById('editImageUrl').value = data.image_url || data.imagem_url || '';
                    
                    if (data.image_url || data.imagem_url) {
                        document.getElementById('editImagePreview').src = data.image_url || data.imagem_url;
                        document.getElementById('editImagePreview').style.display = 'block';
                    }
                    
                    if (data.publish_at) {
                        // Formata para 'datetime-local' (YYYY-MM-DDTHH:mm)
                        const d = new Date(data.publish_at);
                        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                        document.getElementById('editPublishAt').value = d.toISOString().slice(0, 16);
                    }
                    
                    document.getElementById('editModal').classList.remove('hidden');

                } catch (err) {
                    alert('Erro ao carregar dados da not√≠cia: ' + err.message);
                }
            }
        }
        
        // -------------------------------------------------------------------
        // L√ìGICA DE IMAGEM E SALVAMENTO (NOVA)
        // -------------------------------------------------------------------

        function updateImagePreview() {
            const url = document.getElementById('editImageUrl').value;
            const preview = document.getElementById('editImagePreview');
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = 'Enviando imagem...';
            statusEl.style.color = '#888';
            
            try {
                const fileExt = file.name.split('.').pop();
                const filePath = `public/${Date.now()}-${Math.random().toString(36).slice(2)}.${fileExt}`;
                
                const { error: uploadError } = await supabaseClient
                    .storage
                    .from(STORAGE_BUCKET)
                    .upload(filePath, file);

                if (uploadError) throw uploadError;
                
                const { data } = supabaseClient
                    .storage
                    .from(STORAGE_BUCKET)
                    .getPublicUrl(filePath);

                if (!data.publicUrl) {
                    throw new Error('N√£o foi poss√≠vel obter a URL p√∫blica da imagem.');
                }

                statusEl.textContent = 'Upload conclu√≠do!';
                statusEl.style.color = 'green';
                document.getElementById('editImageUrl').value = data.publicUrl;
                updateImagePreview();

            } catch (error) {
                console.error('Erro no upload:', error);
                statusEl.textContent = `Erro no upload: ${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        async function saveNoticia(action) {
            if (!supabaseClient) {
                alert('Configure o Supabase primeiro!');
                return;
            }

            const id = document.getElementById('editId').value || null;
            const sourceTable = document.getElementById('editSourceTable').value;
            
            const publishAtInput = document.getElementById('editPublishAt').value;
            let publishAtValue = null;

            if (action === 'publish_now') {
                publishAtValue = new Date().toISOString();
            } else if (action === 'schedule' && publishAtInput) {
                publishAtValue = new Date(publishAtInput).toISOString();
            } else if (action === 'schedule' && !publishAtInput) {
                alert('Por favor, defina uma data e hora para agendar.');
                return;
            }
            // Se for 'draft', publishAtValue permanece null

            // Monta o objeto da not√≠cia para a tabela 'noticias'
            const postData = {
                title: document.getElementById('editTitle').value,
                content: document.getElementById('editContent').value,
                category: document.getElementById('editCategory').value,
                image_url: document.getElementById('editImageUrl').value,
                headline_color: document.getElementById('editHeadlineColor').value,
                publish_at: publishAtValue // Coluna para agendamento
            };

            try {
                if (sourceTable === DB_TABLE_PUBLISHED) {
                    // --- Caso 1: Editando not√≠cia existente ou criando manual ---
                    
                    if (id) {
                        // Atualiza existente
                        const { error } = await supabaseClient
                            .from(DB_TABLE_PUBLISHED)
                            .update(postData)
                            .eq('id', id);
                        if (error) throw error;
                    } else {
                        // Cria nova
                        const { error } = await supabaseClient
                            .from(DB_TABLE_PUBLISHED)
                            .insert(postData);
                        if (error) throw error;
                    }
                    
                } else if (sourceTable === DB_TABLE_SCRAPED) {
                    // --- Caso 2: Editando not√≠cia scraped ---

                    const scrapedData = {
                        titulo_reescrito: postData.title,
                        conteudo_reescrito: postData.content,
                        resumo_reescrito: postData.content.replace(/<[^>]+>/g, "").substring(0, 500),
                        categoria: postData.category,
                        imagem_url: postData.image_url,
                        headline_color: postData.headline_color
                    };

                    if (action === 'draft') {
                        // Apenas salva o rascunho na tabela scraped
                        const { error } = await supabaseClient
                            .from(DB_TABLE_SCRAPED)
                            .update(scrapedData)
                            .eq('id', id);
                        if (error) throw error;
                        
                    } else {
                        // Publica ou Agenda
                        // 1. Insere na tabela 'noticias'
                        const { error: insertError } = await supabaseClient
                            .from(DB_TABLE_PUBLISHED)
                            .insert(postData);
                        if (insertError) throw insertError;
                        
                        // 2. Atualiza o status da 'noticias_scraped'
                        const { error: updateError } = await supabaseClient
                            .from(DB_TABLE_SCRAPED)
                            .update({ status: 'publicado' })
                            .eq('id', id);
                        if (updateError) throw updateError;
                    }
                }
                
                alert('Not√≠cia salva com sucesso!');
                closeEditModal();
                loadNoticias();
                loadScrapedNoticias();

            } catch (error) {
                alert('Erro ao salvar: ' + error.message);
                console.error('Erro ao salvar:', error);
            }
        }
        
        // -------------------------------------------------------------------
        // FUN√á√ïES DE EXCLUS√ÉO (DO C√ìDIGO ANTIGO, MAS APONTANDO PARA CONSTANTES)
        // -------------------------------------------------------------------

        async function deleteNoticia(id) {
            if (!confirm('Excluir esta not√≠cia publicada permanentemente?')) return;
            if (!supabaseClient) return;

            try {
                const { error } = await supabaseClient
                    .from(DB_TABLE_PUBLISHED)
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                alert('Not√≠cia publicada exclu√≠da!');
                loadNoticias();
            } catch (error) {
                alert('Erro ao excluir: ' + error.message);
            }
        }
        
        async function deleteScrapedNoticia(scrapedId) {
            if (!confirm('Excluir esta not√≠cia scraped permanentemente?')) return;
            if (!supabaseClient) return;

            try {
                const { error } = await supabaseClient
                    .from(DB_TABLE_SCRAPED)
                    .delete()
                    .eq('id', scrapedId);
                if (error) throw error;
                alert('Not√≠cia scraped exclu√≠da!');
                loadScrapedNoticias();
            } catch (error) {
                alert('Erro ao excluir: ' + error.message);
            }
        }

        // Fun√ß√µes antigas removidas (publishNoticia, editNoticia, publishScrapedNoticia)
        // pois foram substitu√≠das pelo novo modal.

        // Inicializa quando a p√°gina carrega
        window.addEventListener('DOMContentLoaded', initSupabase);
    </script>


</body>
</html>