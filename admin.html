<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin - SeligaManaux</title>
<!-- Bibliotecas e estilos -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin:0; padding:0; box-sizing: border-box }
  body { font-family: Arial, sans-serif; background:#0b0b0b; color:#fff; padding:20px; line-height:1.4; }
  .container { max-width:1200px; margin:0 auto; }
  h1 { text-align:center; margin-bottom:30px; color:#dc2626; font-size:2.2em; }

  /* Condensed styles for boxes */
  section { background:#1f1f1f; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #2d2d2d; }

  /* Destaque para section de scrap */
  section.scraped { background:#121826; border:2px solid #059669; }

  /* Estilo para configura√ß√£o de API */
  .api-config { background:#111827; }
  .form-group { margin-bottom:15px; }
  label { display:block; margin-bottom:5px; font-weight:bold; font-size:0.9em; }
  input[type=text], input[type=email], input[type=password], textarea, select { width:100%; padding:10px; margin-top:2px; border-radius:4px; border:1px solid #404040; background:#222; color:#fff; font-size:1em; }
  button { padding:12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:1em; transition:background 0.2s; }
  button:hover { filter: brightness(0.85); }

  /* Bot√µes espec√≠ficos */
  .btn-save { background:#059669; color:#fff; }
  .btn-save:hover { background:#047857; }
  .btn-scrape { background:#059669; }
  .btn-scrape:hover { background:#047857; }
  .btn-publish { background:#7c3aed; }
  .btn-publish:hover { background:#6d28d9; }
  .btn-delete { background:#ef4444; }
  .btn-delete:hover { background:#dc2626; }

  /* Se√ß√£o de not√≠cias */
 .noticias-container { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:15px; margin-top:20px; }
  .noticia-card { background:#222; padding:15px; border-radius:8px; border-left:4px solid #dc2626; display:flex; flex-direction:column; gap:8px; transition: background 0.2s; }
  .noticia-card:hover { background:#2a2a2a; }
  .noticia-title { font-weight: bold; font-size:1.1em; color:#fff; }
  .noticia-content { font-size:0.95em; color:#ccc; max-height:150px; overflow:hidden; }
  .noticia-meta { font-size:0.8em; color:#9ca3af; }
  .noticia-actions { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  .noticia-actions button { flex:1; padding:8px; border-radius:4px; font-size:0.9em; }

  /* Estado e feedback */
  .loading { text-align:center; padding:20px; font-size:1.1em; color:#9ca3af; }
  .erro { background:#dc2626; padding:15px; border-radius:6px; margin:10px 0; font-size:0.95em; }
  .aviso { background:#f59e0b; padding:15px; border-radius:6px; margin:10px 0; font-size:0.95em; }
  .muted { font-size:0.8em; color:#9ca3af; }

  /* Bot√µes de carregamento e a√ß√µes secund√°rias */
  .btn-load { background:#059669; }
  .btn-load:hover { filter: brightness(0.85); }

  /* Outros estilos */
  a { color:#34d399; text-decoration:underline; }
</style>
</head>
<body>
<div class="container">
<h1>SeligaManaux - Painel Administrativo</h1>

<!-- Aviso de configura√ß√£o API -->
<section id="warningBox" class="erro hidden">
  <h3>‚ö†Ô∏è Importante: Configure as API Keys</h3>
  <p>Se aparecer "Invalid API key", atualize a Anon Key nas configura√ß√µes abaixo.</p>
</section>

<!-- Configura√ß√£o API -->
<section class="api-config">
  <h3>Configura√ß√£o de API</h3>
  <p>Copie as chaves p√∫blicas do [Supabase Dashboard ‚Üí Settings ‚Üí API].</p>
  <div class="form-group">
    <label for="supabaseUrl">URL do Supabase</label>
    <input id="supabaseUrl" type="text" value="https://xtnqypmezntjcidglblc.supabase.co" />
  </div>
  <div class="form-group">
    <label for="anonKey">Chave An√¥nima (public)</label>
    <input id="anonKey" type="text" placeholder="Cole aqui sua chave p√∫blica" />
  </div>
  <button class="btn-save" onclick="updateApiConfig()">Salvar configura√ß√£o</button>
  <p class="muted">Configura√ß√µes salvas localmente no navegador.</p>
</section>

<!-- Se√ß√£o Autentica√ß√£o -->
<section class="auth-section">
  <div id="loginForm">
    <h3>Login</h3>
    <input id="email" type="email" placeholder="Email" value="tirra@tirracred.com.br" />
    <input id="password" type="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>
    <p id="loginStatus" class="muted"></p>
  </div>
  <div id="userInfo" class="hidden">
    <p>Usu√°rio: <span id="userEmail"></span></p>
    <button onclick="logout()">Sair</button>
  </div>
</section>

<!-- Painel principal -->
<section id="adminPanel" class="hidden">

  <!-- Buscar not√≠cias autom√°ticas -->
  <div class="scraped hidden">
    <h3>Buscar Not√≠cias Autom√°ticas</h3>
    <p>Envie solicita√ß√µes para coleta, reescrita e grava√ß√£o autom√°tica via Edge Function. Use os bot√µes abaixo:</p>
    <div style="display:flex; flex-wrap:wrap; gap:10px;">
      <button class="btn-scrape" onclick="scrapePortal('g1-am','G1 Amazonas')">üì∞ G1 Amazonas</button>
      <button class="btn-scrape" onclick="scrapePortal('holanda','Portal do Holanda')">üåê Portal do Holanda</button>
      <button class="btn-scrape" onclick="scrapePortal('acritica','A Cr√≠tica')">üìÑ A Cr√≠tica</button>
      <button class="btn-scrape" onclick="scrapePortal('portalamazonia','Portal Amaz√¥nia')">üåø Portal Amaz√¥nia</button>
    </div>
    <div id="scrapeStatus" class="loading" style="display:none;">Buscando not√≠cias... Aguarde.</div>
  </div>

  <!-- Not√≠cias pendentes -->
  <section>
    <h3>Not√≠cias Scraped Pendentes</h3>
    <p>Itens aguardando revis√£o ou publica√ß√£o.</p>
    <button class="btn-load" onclick="loadScrapedNoticias()">üîÑ Recarregar</button>
    <div id="scrapedNoticias" class="noticias-container"></div>
  </section>

  <!-- Criar not√≠cia manual -->
  <section>
    <h3>Criar Not√≠cia Manual</h3>
    <div class="form-group">
      <label for="title">T√≠tulo</label>
      <input id="title" type="text" placeholder="T√≠tulo da not√≠cia" />
    </div>
    <div class="form-group">
      <label for="content">Conte√∫do</label>
      <textarea id="content" rows="10" placeholder="Conte√∫do completo da not√≠cia"></textarea>
    </div>
    <div class="form-group">
      <label for="category">Categoria</label>
      <select id="category">
        <option>Geral</option>
        <option>Pol√≠tica</option>
        <option>Economia</option>
        <option>Esportes</option>
        <option>Cultura</option>
        <option>Amazonas</option>
      </select>
    </div>
    <button class="btn-publish" onclick="publishNoticia()">üìù Publicar</button>
  </section>

  <!-- Not√≠cias Publicadas -->
  <section>
    <h3>Not√≠cias Publicadas</h3>
    <button class="btn-load" onclick="loadNoticias()">üîÑ Recarregar</button>
    <div id="noticias"></div>
  </section>

</section>
</div>

<script>
  // =========================== //
  // Vari√°veis globais e configura√ß√£o
  // =========================== //
  let supabase; let session = null;
  const DEFAULT_URL = 'https://xtnqypmezntjcidglblc.supabase.co';
  const EDGE_FUNC_URL = `${DEFAULT_URL}/functions/v1/scraper`;
  
  // Carregar config
  function getConfig() {
    return {
      url: localStorage.getItem('supabase_url') || document.getElementById('supabaseUrl').value || DEFAULT_URL,
      key: localStorage.getItem('supabase_anon_key') || document.getElementById('anonKey').value || ''
    };
  }
  function saveConfig(url, key) {
    localStorage.setItem('supabase_url', url);
    localStorage.setItem('supabase_anon_key', key);
  }

  // Atualizar configura√ß√£o
  function updateApiConfig() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('anonKey').value.trim();
    if (!url || !key) return alert("Preencha URL e Chave.");
    saveConfig(url, key);
    initSupabase(true);
    alert('Configura√ß√£o salva.');
  }

  // =========================== //
  // Initializa√ß√£o do Supabase
  // =========================== //
  function initSupabase(forcar = false) {
    try {
      const { url, key } = getConfig();
      // Exibir aviso se chave n√£o preenchida
      document.getElementById('warningBox').classList.toggle('hidden', !!key);
      // Criar cliente
      const { createClient } = supabase; // var global do CDN
      supabase = createClient(url, key, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });
      if (forcar) {
        supabase.auth.getSession().then(({ data }) => { session = data.session; syncUI(); });
      }
      supabase.auth.onAuthStateChange((_event, sess) => { session = sess; syncUI(); });
    } catch (err) {
      console.error('Erro na inicializa√ß√£o:', err);
    }
  }

  // Sincronizar UI com status de sess√£o
  function syncUI() {
    const logado = !!session;
    document.getElementById('loginForm').classList.toggle('hidden', logado);
    document.getElementById('userInfo').classList.toggle('hidden', !logado);
    document.getElementById('adminPanel').classList.toggle('hidden', !logado);
    if (logado) {
      document.getElementById('userEmail').textContent = session.user?.email || '(sem email)';
      loadScrapedNoticias();
      loadNoticias();
    } else {
      document.getElementById('loginStatus').textContent = '';
    }
  }

  // =========================== //
  // Autentica√ß√£o
  // =========================== //
  async function login() {
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;
      session = data.session;
    } catch (err) {
      alert('Erro de login: ' + (err.message || err));
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    session = null; syncUI();
  }

  // =========================== //
  // Fun√ß√£o principal de scrape por portalId
  // =========================== //
  async function scrapePortal(portalId, nomeFonte) {
    if (!session || !supabase) return alert('Fa√ßa login primeiro.');
    const statusEl = document.getElementById('scrapeStatus');
    statusEl.style.display = 'block';
    statusEl.textContent = `Buscando de ${nomeFonte}... Aguarde.`;
    statusEl.style.color = '#9ca3af';
    try {
      const { key } = getConfig();
      const res = await fetch(EDGE_FUNC_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
          'apikey': key
        },
        body: JSON.stringify({ portalId }) // Envio via portalId
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || data?.message || 'Falha na coleta');
      const coletados = data?.coletados || 0;
      const salvos = data?.salvos || 0;
      statusEl.textContent = `Sucesso! ${nomeFonte} ‚Äî links: ${coletados}, salvos: ${salvos}`;
      statusEl.style.color = '#10b981';
      setTimeout(loadScrapedNoticias, 1500);
    } catch (err) {
      console.error('Erro:', err);
      statusEl.textContent = `Erro: ${err.message}`;
      statusEl.style.color = '#ef4444';
    } finally {
      setTimeout(() => { statusEl.style.display='none'; }, 5000);
    }
  }

  // =========================== //
  // Carregar not√≠cias pendentes
  // =========================== //
  async function loadScrapedNoticias() {
    const container = document.getElementById('scrapedNoticias');
    container.innerHTML = '<div class="loading">Carregando not√≠cias...</div>';
    if (!supabase) { container.innerHTML='<div class="erro">Erro na configura√ß√£o.</div>'; return; }
    try {
      const { data, error } = await supabase
        .from('noticias_scraped')
        .select('*')
        .in('status', ['rascunho','processado'])
        .order('created_at', { ascending:false })
        .limit(30);
      if (error) throw error;
      if (!data || data.length===0) {
        container.innerHTML='<div class="loading">Nenhuma not√≠cia pendente.</div>'; return;
      }
      container.innerHTML = data.map(n => {
        const img = n.imagem_url ? `<img src="${n.imagem_url}" class="noticia-image" onerror="this.style.display='none'" />` : '';
        const titulo = n.titulo_reescrito || n.titulo_original || 'Sem t√≠tulo';
        const resumo = (n.conteudo_reescrito || n.resumo_reescrito || n.resumo_original || '').toString();
        const snippet = resumo.substring(0,200) + (resumo.length>200?'...':'');
        const statusClass = `status-${(n.status || 'rascunho').toLowerCase()}`;
        const dataColeta = n.data_coleta || n.created_at;
        const dataTxt = dataColeta ? new Date(dataColeta).toLocaleString('pt-BR') : 'N/D';
        return `
        <div class="noticia-card scraped">
          ${img}
          <div class="noticia-title">${titulo}</div>
          <div class="noticia-content">${snippet}</div>
          <div class="noticia-meta">
            <span class="status-badge ${statusClass}">${n.status || 'rascunho'}</span>
            <br><strong>Fonte:</strong> ${n.fonte||'N/D'}<br>
            <strong>Categoria:</strong> ${n.categoria||'Geral'}<br>
            <strong>Coletado:</strong> ${dataTxt}
            <br><a href="${n.url_original}" target="_blank">Ver original</a>
          </div>
          <div class="noticia-actions">
            <button onclick="publishScrapedNoticia(${n.id})" class="btn-publish">Publicar</button>
            <button onclick="deleteScrapedNoticia(${n.id})" class="btn-delete">Excluir</button>
          </div>
        </div>`;
      }).join('');
    } catch (err) {
      console.error('Erro ao carregar:', err);
      container.innerHTML = `<div class="erro">Erro: ${err.message}</div>`;
    }
  }

  // Publicar scraped - move para noticias
  async function publishScrapedNoticia(id) {
    if (!confirm('Publicar esta not√≠cia?')) return;
    if (!supabase) return alert('Configura√ß√£o do banco n√£o encontrada.');
    try {
      const { data: scraped, error } = await supabase
        .from('noticias_scraped')
        .select('*')
        .eq('id', id).single();
      if (error) throw error;
      const conteudo = scraped.conteudo_reescrito || scraped.resumo_reescrito || scraped.resumo_original || '';
      await supabase
        .from('noticias')
        .insert({ title: scraped.titulo_reescrito || scraped.titulo_original || 'Sem t√≠tulo', content: conteudo, category: scraped.categoria || 'Geral', image_url: scraped.imagem_url });
      // atualizar status do scraped para 'publicado'
      await supabase.from('noticias_scraped').update({ status: 'publicado' }).eq('id', id);
      alert('Publicada com sucesso');
      loadScrapedNoticias();
      loadNoticias();
    } catch (err) {
      alert('Erro: ' + (err.message || err));
    }
  }

  // Excluir not√≠cia scraped
  async function deleteScrapedNoticia(id) {
    if (!confirm('Excluir esta not√≠cia?')) return;
    if (!supabase) return;
    try {
      await supabase.from('noticias_scraped').delete().eq('id', id);
      alert('Exclu√≠da');
      loadScrapedNoticias();
    } catch (err) {
      alert('Erro: ' + (err.message || err));
    }
  }

  // Carregar not√≠cias publicadas
  async function loadNoticias() {
    const container = document.getElementById('noticias');
    container.innerHTML = '<div class="loading">Carregando not√≠cias...</div>';
    if (!supabase) return;
    try {
      const { data, error } = await supabase
        .from('noticias')
        .select('*')
        .order('created_at', { ascending:false })
        .limit(24);
      if (error) throw error;
      if (!data || data.length===0) {
        container.innerHTML = '<div class="loading">Nenhuma not√≠cia publicada</div>'; return;
      }
      container.innerHTML = data.map(n => {
        const img = n.image_url ? `<img src="${n.image_url}" class="noticia-image" onerror="this.style.display='none'" />` : '';
        const titulo = n.title || 'Sem t√≠tulo';
        const snippet = (n.content || '').substring(0,200) + (n.content && n.content.length>200?'...':'');
        const dataPublicado = n.created_at ? new Date(n.created_at).toLocaleString('pt-BR') : 'N/D';
        return `
        <div class="noticia-card">
          ${img}
          <div class="noticia-title">${titulo}</div>
          <div class="noticia-content">${snippet}</div>
          <div class="noticia-meta">
            <strong>Categoria:</strong> ${n.category || 'Geral'}<br>
            <strong>Publicada:</strong> ${dataPublicado}
          </div>
          <div class="noticia-actions">
            <button onclick="editNoticia(${n.id})">‚úèÔ∏è Editar</button>
            <button class="btn-delete" onclick="deleteNoticia(${n.id})">üóëÔ∏è Excluir</button>
          </div>
        </div>`;
      }).join('');
    } catch (err) {
      console.error('Erro:', err);
      document.getElementById('noticias').innerHTML = `<div class="erro">Erro: ${err.message}</div>`;
    }
  }

  // A√ß√µes
  function editNoticia(id) { alert('Edi√ß√£o n√£o implementada: ' + id); }

  async function deleteNoticia(id) {
    if (!confirm('Excluir?')) return;
    try {
      await supabase.from('noticias').delete().eq('id', id);
      loadNoticias();
    } catch (err) {
      alert('Erro: ' + (err.message || err));
    }
  }

  // =========================== //
  // Evento inicial
  // =========================== //
  window.addEventListener('DOMContentLoaded', () => {
    // Preenche config
    const url = localStorage.getItem('supabase_url') || DEFAULT_URL;
    const key = localStorage.getItem('supabase_anon_key') || '';
    document.getElementById('supabaseUrl').value = url;
    document.getElementById('anonKey').value = key;
    initSupabase(true);
  });
</script>




</body>



</html>


