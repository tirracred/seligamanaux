<!doctype html>
<html lang="pt-br" class="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin | seligamanaux</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    .brand-red { background-color: #7a0a0a; }
    .brand-accent { color: #e11d48; }
    .brand-blue { color: #3b82f6; }
    .card { background:#0b0b0b; border:1px solid #1f2937; border-radius:12px; }
    .btn { border-radius:10px; padding:0.55rem 0.9rem; font-weight:600; }
    .btn-red { background:#b91c1c; color:#fff; }
    .btn-blue { background:#2563eb; color:#fff; }
    .btn-green { background:#15803d; color:#fff; }
    .btn-ghost { background:transparent; border:1px solid #374151; color:#e5e7eb; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .chip { border:1px solid #374151; border-radius:9999px; padding:.15rem .55rem; font-size:.75rem; }
    .grid-news { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:1024px){ .grid-news { grid-template-columns: 1.5fr 1fr; } }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid #1f2937; padding:.6rem .5rem; text-align:left; vertical-align:top; }
    .table tr:hover { background:#0f172a; }
    .pill { padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; }

    /* line-clamp sem plugin do Tailwind */
    .line-clamp-1, .line-clamp-2 { display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-1 { -webkit-line-clamp: 1; }
    .line-clamp-2 { -webkit-line-clamp: 2; }
  </style>
</head>
<body class="bg-black text-gray-100">
  <header class="brand-red text-white">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="text-2xl font-bold tracking-wider">seligamanaux</div>
      <nav class="flex items-center gap-4 text-sm">
        <span class="hidden md:inline text-gray-200">Administração de conteúdo</span>
        <span class="chip">Dark mode</span>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="grid-news">
      <!-- Coluna: Scraper e Ações -->
      <div class="card p-4">
        <h2 class="text-xl font-semibold mb-3">
          Coleta e reescrita <span class="brand-accent">multi‑portal</span>
        </h2>
        <p class="text-sm text-gray-400 mb-4">
          Dispare a Edge Function por portal. Enviaremos <code>{ "portalId": "...", "max": 8-15 }</code> no corpo do POST.
        </p>

        <div class="mb-3 flex items-center gap-2">
          <label class="text-sm text-gray-300">Qtd. itens por execução</label>
          <input id="max-items" type="number" min="1" max="15" value="8"
                 class="bg-black border border-gray-700 rounded px-2 py-1 w-20"/>
        </div>

        <div id="portal-buttons" class="flex flex-wrap gap-2 mb-3"></div>

        <div class="text-xs text-gray-500">
          Dica: se aparecer “Invalid API key”, confira a URL e a Anon Key nas Configurações e teste a conexão.
        </div>
      </div>

      <!-- Coluna: Configurações -->
      <div class="card p-4">
        <h2 class="text-xl font-semibold mb-3">
          Configurações <span class="brand-blue">Supabase</span>
        </h2>
        <div class="grid md:grid-cols-1 gap-3">
          <div>
            <label class="text-sm text-gray-300">SUPABASE_URL</label>
            <input id="cfg-url" class="w-full bg-black border border-gray-700 rounded px-3 py-2"
                   placeholder="https://xxxxx.supabase.co"/>
          </div>
          <div>
            <label class="text-sm text-gray-300">SUPABASE_ANON_KEY</label>
            <input id="cfg-key" class="w-full bg-black border border-gray-700 rounded px-3 py-2"
                   placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
          </div>
          <div>
            <label class="text-sm text-gray-300">EDGE_FN_URL (POST)</label>
            <input id="cfg-edge" class="w-full bg-black border border-gray-700 rounded px-3 py-2"
                   placeholder="/functions/v1/scraper" />
          </div>
          <div class="flex gap-2">
            <button class="btn btn-green" onclick="saveConfig()">Salvar</button>
            <button class="btn btn-blue" onclick="testConnection()">Testar conexão</button>
            <button class="btn btn-ghost" onclick="clearConfig()">Limpar</button>
          </div>
          <div id="cfg-status" class="text-sm text-gray-400"></div>
        </div>
      </div>
    </section>

    <!-- Filtros e Lista -->
    <section class="card p-4 mt-6">
      <div class="flex flex-col md:flex-row md:items-end gap-3 mb-4">
        <div class="flex-1">
          <label class="text-sm text-gray-300">Busca por título</label>
          <input id="search" class="w-full bg-black border border-gray-700 rounded px-3 py-2"
                 placeholder="Digite parte do título reescrito..." />
        </div>
        <div>
          <label class="text-sm text-gray-300">Status</label>
          <select id="filter-status" class="bg-black border border-gray-700 rounded px-3 py-2">
            <option value="todos">Todos</option>
            <option value="gerado">Gerado</option>
            <option value="ignorado">Ignorado</option>
            <option value="aprovado">Aprovado</option>
            <option value="rejeitado">Rejeitado</option>
            <option value="publicado">Publicado</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300">Itens por página</label>
          <select id="page-size" class="bg-black border border-gray-700 rounded px-3 py-2">
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
          </select>
        </div>
        <div>
          <button class="btn btn-blue" onclick="reload()">Aplicar</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="table text-sm" id="table-news">
          <thead class="text-gray-300">
            <tr>
              <th style="width:28%">Título</th>
              <th style="width:14%">Fonte</th>
              <th style="width:12%">Coleta</th>
              <th style="width:10%">Status</th>
              <th style="width:10%">Tamanho</th>
              <th style="width:26%">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody-news"></tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div id="pager-info" class="text-xs text-gray-400">—</div>
        <div class="flex gap-2">
          <button class="btn btn-ghost" onclick="prevPage()">Anterior</button>
          <button class="btn btn-ghost" onclick="nextPage()">Próxima</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-white text-black">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="font-semibold">seligamanaux</div>
      <div class="text-sm">Admin • Conteúdo • Publicação</div>
    </div>
  </footer>

  <!-- Supabase JS v2 (browser) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ---------- Portais (botões gerados dinamicamente) ----------
    const PORTAIS = [
      { id: "g1-am", label: "G1 Amazonas" },
      { id: "portaldoholanda", label: "Portal do Holanda" },
      { id: "acritica", label: "A Crítica" },
      { id: "portalamazonia", label: "Portal Amazônia" },
    ];

    // ---------- Estado ----------
    let supabase = null;
    let currentPage = 1;
    let total = 0;

    // ---------- DOM ----------
    const elButtons = document.getElementById("portal-buttons");
    const elMax = document.getElementById("max-items");
    const elCfgUrl = document.getElementById("cfg-url");
    const elCfgKey = document.getElementById("cfg-key");
    const elCfgEdge = document.getElementById("cfg-edge");
    const elCfgStatus = document.getElementById("cfg-status");
    const elSearch = document.getElementById("search");
    const elFilterStatus = document.getElementById("filter-status");
    const elPageSize = document.getElementById("page-size");
    const elTbody = document.getElementById("tbody-news");
    const elPagerInfo = document.getElementById("pager-info");

    // ---------- Config persistida ----------
    function loadConfig() {
      elCfgUrl.value = localStorage.getItem("SB_URL") || "";
      elCfgKey.value = localStorage.getItem("SB_ANON") || "";
      elCfgEdge.value = localStorage.getItem("EDGE_FN") || "/functions/v1/scraper";
      initSupabase();
    }

    function saveConfig() {
      localStorage.setItem("SB_URL", elCfgUrl.value.trim());
      localStorage.setItem("SB_ANON", elCfgKey.value.trim());
      localStorage.setItem("EDGE_FN", elCfgEdge.value.trim());
      initSupabase();
      toast("Configurações salvas.");
    }

    function clearConfig() {
      localStorage.removeItem("SB_URL");
      localStorage.removeItem("SB_ANON");
      localStorage.removeItem("EDGE_FN");
      elCfgUrl.value = "";
      elCfgKey.value = "";
      elCfgEdge.value = "/functions/v1/scraper";
      supabase = null;
      toast("Configurações limpas.");
    }

    function initSupabase() {
      const url = elCfgUrl.value.trim();
      const key = elCfgKey.value.trim();
      if (!url || !key) {
        elCfgStatus.textContent = "Configure SUPABASE_URL e ANON_KEY.";
        return;
      }
      try {
        supabase = createClient(url, key, { auth: { persistSession: false } });
        elCfgStatus.textContent = "Cliente Supabase inicializado.";
      } catch (e) {
        elCfgStatus.textContent = "Falha ao inicializar Supabase: " + e;
      }
    }

    async function testConnection() {
      if (!supabase) { initSupabase(); }
      if (!supabase) { return toast("Configuração incompleta."); }
      const { error } = await supabase
        .from("noticias_scraped")
        .select("id", { count: "exact", head: true })
        .limit(1);
      elCfgStatus.textContent = error ? ("Erro: " + error.message) : "Conexão OK.";
      toast(error ? ("Erro: " + error.message) : "Conexão OK.");
    }

    // ---------- Botões de Portais ----------
    function renderPortalButtons() {
      elButtons.innerHTML = "";
      PORTAIS.forEach(p => {
        const b = document.createElement("button");
        b.className = "btn btn-red";
        b.textContent = p.label;
        b.onclick = () => scrapePortal(p.id, p.label, b);
        elButtons.appendChild(b);
      });
    }

    async function scrapePortal(portalId, label, btn) {
      const edgeUrl = elCfgEdge.value.trim() || "/functions/v1/scraper";
      const max = Math.min(Math.max(parseInt(elMax.value || "8", 10), 1), 15);
      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = `Processando ${label}...`;
      try {
        const res = await fetch(edgeUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ portalId, max })
        });

        let data = null;
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          const errMsg = (data && data.error) ? data.error : `HTTP ${res.status}`;
          throw new Error(errMsg);
        }

        toast(`${label}: ${data?.processed ?? 0} itens processados.`);
        reload();
      } catch (e) {
        toast(`Falha ao processar ${label}: ${e?.message || e}`, true);
      } finally {
        btn.disabled = false;
        btn.textContent = prev;
      }
    }

    // ---------- Listagem ----------
    function getPageSize() { return parseInt(elPageSize.value || "20", 10); }

    async function loadItems() {
      if (!supabase) { initSupabase(); }
      if (!supabase) return;

      const pageSize = getPageSize();
      const from = (currentPage - 1) * pageSize;
      const to = from + pageSize - 1;

      let q = supabase
        .from("noticias_scraped")
        .select("id,titulo_reescrito,conteudo_reescrito,url_original,fonte,categoria,status,data_coleta", { count: "exact" })
        .order("data_coleta", { ascending: false })
        .range(from, to);

      const term = (elSearch.value || "").trim();
      if (term) q = q.ilike("titulo_reescrito", `%${term}%`);

      const f = elFilterStatus.value;
      if (f && f !== "todos") q = q.eq("status", f);

      const { data, count, error } = await q;
      if (error) {
        elTbody.innerHTML = `<tr><td colspan="6" class="text-red-400">${escapeHtml(error.message)}</td></tr>`;
        elPagerInfo.textContent = "—";
        return;
      }
      total = count || 0;
      renderRows(data || []);
      renderPager();
    }

    function renderRows(rows) {
      elTbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");

        const tTitulo = document.createElement("td");
        tTitulo.innerHTML = `
          <div class="line-clamp-2 font-medium">${escapeHtml(r.titulo_reescrito || "(sem título)")}</div>
          <div class="text-xs text-gray-400 line-clamp-1">${escapeHtml(r.url_original || "")}</div>
        `;

        const tFonte = document.createElement("td");
        tFonte.textContent = `${r.fonte || "-"} • ${r.categoria || "-"}`;

        const tData = document.createElement("td");
        tData.textContent = r.data_coleta
          ? new Date(r.data_coleta).toLocaleString("pt-BR")
          : "-";

        const tStatus = document.createElement("td");
        tStatus.innerHTML = `
          <select class="bg-black border border-gray-700 rounded px-2 py-1 text-xs">
            ${["gerado","ignorado","aprovado","rejeitado","publicado"].map(s => `
              <option value="${s}" ${r.status===s?"selected":""}>${s}</option>
            `).join("")}
          </select>
        `;
        const sel = tStatus.querySelector("select");
        sel.onchange = () => updateStatus(r.id, sel.value);

        const tTam = document.createElement("td");
        const len = (r.conteudo_reescrito || "").length;
        tTam.textContent = len ? `${len.toLocaleString("pt-BR")} chars` : "-";

        const tAcoes = document.createElement("td");
        tAcoes.className = "flex flex-wrap gap-2";
        tAcoes.appendChild(makeLink("Original", r.url_original));
        tAcoes.appendChild(makeBtn("Copiar título", () => copy(r.titulo_reescrito||"")));
        tAcoes.appendChild(makeBtn("Copiar conteúdo", () => copy(r.conteudo_reescrito||"")));
        tAcoes.appendChild(makeBtn("Aprovar", () => updateStatus(r.id, "aprovado"), "btn-green"));
        tAcoes.appendChild(makeBtn("Publicar", () => updateStatus(r.id, "publicado"), "btn-blue"));

        tr.appendChild(tTitulo);
        tr.appendChild(tFonte);
        tr.appendChild(tData);
        tr.appendChild(tStatus);
        tr.appendChild(tTam);
        tr.appendChild(tAcoes);
        elTbody.appendChild(tr);
      });
    }

    function renderPager() {
      const pageSize = getPageSize();
      const pages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, pages);
      elPagerInfo.textContent = `Página ${currentPage} de ${pages} • ${total.toLocaleString("pt-BR")} itens`;
    }

    function prevPage() { if (currentPage > 1) { currentPage--; loadItems(); } }
    function nextPage() {
      const pageSize = getPageSize();
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage < pages) { currentPage++; loadItems(); }
    }
    window.prevPage = prevPage;
    window.nextPage = nextPage;

    function reload() { currentPage = 1; loadItems(); }
    window.reload = reload;

    async function updateStatus(id, status) {
      if (!supabase) return;
      const patch = { status };
      if (status === "publicado") patch["data_publicacao"] = new Date().toISOString();
      const { error } = await supabase.from("noticias_scraped").update(patch).eq("id", id);
      if (error) { return toast("Erro ao atualizar: " + error.message, true); }
      toast("Status atualizado: " + status);
      loadItems();
    }

    // ---------- Utils ----------
    function makeLink(label, href) {
      const a = document.createElement("a");
      a.href = href || "#";
      a.target = "_blank"; a.rel = "noopener";
      a.className = "btn btn-ghost";
      a.textContent = label;
      if (!href) a.classList.add("opacity-50","pointer-events-none");
      return a;
    }
    function makeBtn(label, fn, cls="btn-ghost") {
      const b = document.createElement("button");
      b.className = "btn " + cls;
      b.textContent = label;
      b.onclick = fn;
      return b;
    }
    function copy(text) {
      navigator.clipboard.writeText(text || "")
        .then(() => toast("Copiado."))
        .catch(() => toast("Falha ao copiar.", true));
    }
    function escapeHtml(s) {
      return (s||"").replace(/[&<>\"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }
    function toast(msg, err=false) {
      const d = document.createElement("div");
      d.textContent = msg;
      d.style.position="fixed"; d.style.right="16px"; d.style.bottom="16px";
      d.style.background = err ? "#7f1d1d" : "#1e293b"; d.style.color="#fff";
      d.style.padding="10px 12px"; d.style.borderRadius="10px"; d.style.zIndex=9999;
      document.body.appendChild(d);
      setTimeout(()=> d.remove(), 3200);
    }

    // Enter para buscar
    elSearch.addEventListener("keydown", (e) => { if (e.key === "Enter") reload(); });

    // ---------- Boot ----------
    renderPortalButtons();
    loadConfig();
    reload();

    // Expor globais necessárias a botões/filtros
    window.saveConfig = saveConfig;
    window.clearConfig = clearConfig;
    window.testConnection = testConnection;
  </script>
</body>
</html>
