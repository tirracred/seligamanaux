<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>

    <header class="site-header">
        <div class="header-container">
            <div class="logo">
                <a href="/"><h1>SeligaManaux (ADMIN)</h1></a>
            </div>
        </div>
    </header>
    
    <main class="container">

        <!-- * NOVO: Formulário de Login * -->
        <form id="login-form" class="admin-form">
            <h1 class="page-title-admin">Login do Administrador</h1>
            
            <div id="login-feedback-message" class="message" style="display: none;"></div>

            <div>
                <label for="admin-email">Email</label>
                <input type="email" id="admin-email" required>
            </div>
            
            <div>
                <label for="admin-password">Senha</label>
                <input type="password" id="admin-password" required>
            </div>
            
            <button type="submit" id="login-button">ENTRAR</button>
            <p id="loading-login" style="display: none; text-align: center; margin-top: 1rem; color: var(--texto-link);">Entrando...</p>
        </form>


        <!-- * Formulário de Notícias (Agora escondido por padrão) * -->
        <form id="news-form" class="admin-form" style="display: none;">
            <h1 class="page-title-admin">Publicar Nova Notícia</h1>
            
            <div id="feedback-message" class="message" style="display: none;"></div>

            <div>
                <label for="news-title">Título</label>
                <input type="text" id="news-title" required>
            </div>
            
            <div>
                <label for="news-category">Categoria</label>
                <select id="news-category" required>
                    <option value="">Selecione...</option>
                    <option value="Manaus e Região">Manaus e Região</option>
                    <option value="Política">Política</option>
                    <option value="Esportes">Esportes</option>
                    <option value="Economia">Economia</option>
                    <option value="Geral">Geral</option>
                </select>
            </div>

            <div>
                <label for="news-content">Conteúdo</label>
                <textarea id="news-content" rows="8" required></textarea>
            </div>

            <div>
                <label for="news-image">Anexar Foto</label>
                <input type="file" id="news-image" accept="image/*">
            </div>
            
            <button type="submit" id="submit-button">PUBLICAR AGORA</button>
            <p id="loading-submit" style="display: none; text-align: center; margin-top: 1rem; color: var(--texto-link);">Publicando... Aguarde.</p>
        </form>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="main.js"></script>

    <script>
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // Referências dos formulários
            const loginForm = document.getElementById('login-form');
            const newsForm = document.getElementById('news-form');
            const loginButton = document.getElementById('login-button');
            const loadingLogin = document.getElementById('loading-login');
            const loginFeedback = document.getElementById('login-feedback-message');
            
            // Referências do form de notícias
            const submitButton = document.getElementById('submit-button');
            const loadingSubmit = document.getElementById('loading-submit');
            const feedbackMessage = document.getElementById('feedback-message');
            
            const newsTitle = document.getElementById('news-title');
            const newsCategory = document.getElementById('news-category');
            const newsContent = document.getElementById('news-content');
            const newsImageInput = document.getElementById('news-image');

            // Evento: Tentar fazer login
            loginForm.addEventListener('submit', handleLogin);

            async function handleLogin(event) {
                event.preventDefault();
                if (!supabase) return showLoginMessage('Erro: Supabase não inicializado', 'error');

                loginButton.disabled = true;
                loadingLogin.style.display = 'block';
                loginFeedback.style.display = 'none';

                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });

                    if (error) throw error;

                    // SUCESSO!
                    // Esconde o login e mostra o formulário de notícias
                    loginForm.style.display = 'none';
                    newsForm.style.display = 'block';

                } catch (err) {
                    console.error("Erro de login:", err);
                    showLoginMessage(`Erro: ${err.message}`, 'error');
                } finally {
                    loginButton.disabled = false;
                    loadingLogin.style.display = 'none';
                }
            }


            // --- Lógica do formulário de notícias (igual a antes) ---
            newsForm.addEventListener('submit', handleFormSubmit);

            async function handleFormSubmit(event) {
                event.preventDefault(); 
                
                if (!supabase) {
                    showMessage('Erro: Falha na conexão com o banco de dados.', 'error');
                    return;
                }
                
                submitButton.disabled = true;
                loadingSubmit.style.display = 'block';
                feedbackMessage.style.display = 'none';

                try {
                    const imageFile = newsImageInput.files[0];
                    let imageUrl = null;
                    
                    if (imageFile) {
                        imageUrl = await uploadMedia(imageFile);
                    }

                    const newPost = {
                        title: newsTitle.value,
                        content: newsContent.value,
                        category: newsCategory.value, 
                        image_url: imageUrl,
                    };

                    const { error } = await supabase
                        .from(DB_TABLE)
                        .insert(newPost);

                    if (error) throw error;

                    showMessage('Sucesso! Notícia publicada.', 'success');
                    newsForm.reset();

                } catch (err) {
                    console.error("Erro ao publicar:", err);
                    // Se o erro for "permission denied", a regra RLS está funcionando!
                    if (err.message.includes("permission denied")) {
                         showMessage('Erro: Você não tem permissão para publicar. Verifique as regras RLS no Supabase.', 'error');
                    } else {
                         showMessage(`Erro: ${err.message}`, 'error');
                    }
                } finally {
                    submitButton.disabled = false;
                    loadingSubmit.style.display = 'none';
                }
            }

            async function uploadMedia(file) {
                if (!file) return null;
                const fileName = `${Date.now()}-${file.name}`;
                
                const { data, error } = await supabase.storage
                    .from(STORAGE_BUCKET)
                    .upload(fileName, file);

                if (error) throw new Error(`Erro no upload: ${error.message}`);
                
                const { data: publicUrlData } = supabase.storage
                    .from(STORAGE_BUCKET)
                    .getPublicUrl(data.path);
                    
                return publicUrlData.publicUrl;
            }
            
            function showMessage(text, type) {
                feedbackMessage.innerText = text;
                feedbackMessage.className = `message ${type}`;
                feedbackMessage.style.display = 'block';
            }
            
            function showLoginMessage(text, type) {
                loginFeedback.innerText = text;
                loginFeedback.className = `message ${type}`;
                loginFeedback.style.display = 'block';
            }
        });
    </script>
</body>
</html>

