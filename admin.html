<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SeligaManaux</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Link para o CSS externo -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>SeligaManaux - Admin</h1>

        <!-- LOGIN -->
        <div class="auth-section">
            <div id="loginForm">
                <h3>Login</h3>
                <input type="email" id="email" placeholder="Email" value="tirra@tirracred.com.br">
                <input type="password" id="password" placeholder="Senha" required>
                <button onclick="login()">Entrar</button>
                <p id="loginStatus"></p>
            </div>
            <div id="userInfo" class="hidden">
                <p>Usu√°rio logado: <span id="userEmail"></span></p>
                <button onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- PAINEL ADMIN -->
        <div id="adminPanel" class="hidden">
            
            <!-- RSS AUTO IMPORTER -->
            <div class="admin-section">
                <h3>ü§ñ RSS Auto Importer</h3>
                <p>Sistema autom√°tico de importa√ß√£o de not√≠cias via RSS.</p>
                
                <div id="rssAutoStatus" style="padding: 15px; background: #1f2937; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Status:</strong> <span id="rssStatus">Aguardando...</span></p>
                    <p><strong>√öltima Execu√ß√£o:</strong> <span id="lastRun">Nunca</span></p>
                    <p><strong>Pr√≥xima Execu√ß√£o:</strong> <span id="nextRun">-</span></p>
                    <p><strong>Total Importado:</strong> <span id="totalImported">0</span> not√≠cias</p>
                </div>
                
                <div class="source-buttons">
                    <button class="scrape-button" onclick="forceRSSImport()">
                        ‚ñ∂Ô∏è Importar RSS Agora
                    </button>
                    <button class="danger-button" onclick="stopAutoImport()">
                        ‚è∏Ô∏è Pausar Auto-Import
                    </button>
                    <button class="publish-button" onclick="startAutoImport()">
                        ‚ñ∂Ô∏è Iniciar Auto-Import (6h)
                    </button>
                </div>
            </div>

            <!-- FERRAMENTAS DE MANUTEN√á√ÉO -->
            <div class="admin-section">
                <h3>üîß Ferramentas de Manuten√ß√£o</h3>
                <p>Fun√ß√µes para gerenciar not√≠cias no banco de dados.</p>
                
                <div class="source-buttons">
                    <button class="publish-button" onclick="publicarTodasPendentes()">
                        ‚úÖ Publicar Todas Pendentes
                    </button>
                    
                    <button class="scrape-button" onclick="atualizarPrioridades()">
                        üîÑ Atualizar Prioridades Antigas
                    </button>
                    
                    <button class="danger-button" onclick="limparBanco()">
                        üóëÔ∏è Limpar Banco (Deletar Tudo)
                    </button>
                </div>
                
                <div id="maintenanceStatus" class="loading hidden"></div>
            </div>

            <!-- CRIAR NOT√çCIA MANUAL -->
            <div class="admin-section">
                <h3>‚úçÔ∏è Criar Not√≠cia Manual</h3>
                <div class="form-group">
                    <label for="title">T√≠tulo:</label>
                    <input type="text" id="title" placeholder="T√≠tulo da not√≠cia">
                </div>
                <div class="form-group">
                    <label for="content">Conte√∫do:</label>
                    <textarea id="content" rows="10" placeholder="Conte√∫do da not√≠cia"></textarea>
                </div>
                <div class="form-group">
                    <label for="category">Categoria:</label>
                    <select id="category">
                        <option value="Geral">Geral</option>
                        <option value="Pol√≠tica">Pol√≠tica</option>
                        <option value="Economia">Economia</option>
                        <option value="Esportes">Esportes</option>
                        <option value="Cultura">Cultura</option>
                        <option value="Amazonas">Amazonas</option>
                        <option value="Crime">Crime</option>
                        <option value="Sa√∫de">Sa√∫de</option>
                        <option value="Educa√ß√£o">Educa√ß√£o</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="manual-image">URL da Imagem (opcional):</label>
                    <input type="url" id="manual-image" placeholder="https://exemplo.com/imagem.jpg">
                </div>
                <button onclick="publishNoticia()">üìù Publicar Not√≠cia</button>
            </div>

            <!-- NOT√çCIAS PUBLICADAS -->
            <div class="admin-section">
                <h3>üì∞ Not√≠cias Publicadas</h3>
                <button onclick="loadNoticias()">üîÑ Recarregar Publicadas</button>
                <div id="noticias" class="noticias-container">
                    <div class="loading">Carregando not√≠cias publicadas...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE EDI√á√ÉO -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Not√≠cia</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="edit-title">T√≠tulo:</label>
                <input type="text" id="edit-title" placeholder="T√≠tulo da not√≠cia">
            </div>
            
            <div class="form-group">
                <label for="edit-content">Conte√∫do:</label>
                <textarea id="edit-content" rows="15" placeholder="Conte√∫do da not√≠cia"></textarea>
            </div>
            
            <div class="form-group">
                <label for="edit-category">Categoria:</label>
                <select id="edit-category">
                    <option value="Geral">Geral</option>
                    <option value="Pol√≠tica">Pol√≠tica</option>
                    <option value="Economia">Economia</option>
                    <option value="Esportes">Esportes</option>
                    <option value="Cultura">Cultura</option>
                    <option value="Amazonas">Amazonas</option>
                    <option value="Crime">Crime</option>
                    <option value="Sa√∫de">Sa√∫de</option>
                    <option value="Educa√ß√£o">Educa√ß√£o</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="edit-image">URL da Imagem (opcional):</label>
                <input type="url" id="edit-image" placeholder="https://exemplo.com/imagem.jpg">
            </div>
            
            <div class="modal-actions">
                <button onclick="closeEditModal()" class="danger-button">‚ùå Cancelar</button>
                <button onclick="saveEditedNoticia()" style="background: #059669;">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURA√á√ÉO ===
        let supabaseClient = null;
        let currentSession = null;
        let currentEditingId = null;

        // RSS Auto Import
        let autoImportInterval = null;
        let isAutoImportRunning = false;
        let totalImportedSession = 0;
        let lastRunTime = null;
        const RSS_IMPORT_INTERVAL = 6 * 60 * 60 * 1000; // 6 horas

        // === INICIALIZA√á√ÉO ===
        function initSupabase() {
            const savedUrl = 'https://xtnqypmezntjcidglblc.supabase.co';
            const savedKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0bnF5cG1lem50amNpZGdsYmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5ODEwMDksImV4cCI6MjA3NzU1NzAwOX0.fz__YKaMuEWjoXVansGZnLgUhsdsg7J1tLCriMhV8Ls';

            try {
                const { createClient } = supabase;
                supabaseClient = createClient(savedUrl, savedKey, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    }
                });

                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (session) {
                        currentSession = session;
                        document.getElementById('loginForm').classList.add('hidden');
                        document.getElementById('userInfo').classList.remove('hidden');
                        document.getElementById('adminPanel').classList.remove('hidden');
                        document.getElementById('userEmail').textContent = session.user.email;
                        loadNoticias();
                        
                        // Restaura auto-import se estava ativo
                        setTimeout(restoreAutoImport, 2000);
                    } else {
                        currentSession = null;
                        document.getElementById('loginForm').classList.remove('hidden');
                        document.getElementById('userInfo').classList.add('hidden');
                        document.getElementById('adminPanel').classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
            }
        }

        // === AUTENTICA√á√ÉO ===
        async function login() {
            if (!supabaseClient) {
                alert('Erro: Cliente Supabase n√£o foi inicializado.');
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('loginStatus');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentSession = data.session;
                statusEl.textContent = 'Login realizado com sucesso!';
                statusEl.style.color = 'green';
            } catch (error) {
                statusEl.textContent = 'Erro: ' + error.message;
                statusEl.style.color = 'red';
                console.error('Erro de login:', error);
            }
        }

        async function logout() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            currentSession = null;
            document.getElementById('loginStatus').textContent = '';
        }

        // === RSS AUTO IMPORT ===
        function updateRSSStatus(message, color) {
            const statusEl = document.getElementById('rssStatus');
            statusEl.textContent = message;
            statusEl.style.color = color;
        }

        async function runAutoRSSImport() {
            if (!supabaseClient || !currentSession) {
                console.log('Auto-import: aguardando login...');
                return;
            }
            
            updateRSSStatus('Importando...', '#f59e0b');
            
            try {
                const { data, error } = await supabaseClient.functions.invoke('rss_import', {
                    body: {}
                });
                
                if (error) {
                    console.error('Erro no auto-import:', error);
                    updateRSSStatus('Erro: ' + error.message, '#dc2626');
                    return;
                }
                
                const imported = data?.processed || 0;
                totalImportedSession += imported;
                lastRunTime = new Date();
                
                document.getElementById('totalImported').textContent = totalImportedSession;
                document.getElementById('lastRun').textContent = lastRunTime.toLocaleString('pt-BR');
                
                updateRSSStatus(`‚úÖ ${imported} not√≠cias importadas`, '#059669');
                
                const nextRun = new Date(Date.now() + RSS_IMPORT_INTERVAL);
                document.getElementById('nextRun').textContent = nextRun.toLocaleString('pt-BR');
                
                loadNoticias();
                
            } catch (error) {
                console.error('Erro cr√≠tico no auto-import:', error);
                updateRSSStatus('Erro cr√≠tico', '#dc2626');
            }
        }

        function startAutoImport() {
            if (isAutoImportRunning) {
                alert('Auto-import j√° est√° rodando!');
                return;
            }
            
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            isAutoImportRunning = true;
            updateRSSStatus('üü¢ Ativo', '#059669');
            
            runAutoRSSImport();
            autoImportInterval = setInterval(runAutoRSSImport, RSS_IMPORT_INTERVAL);
            
            localStorage.setItem('rss_auto_import_enabled', 'true');
            alert('‚úÖ Auto-import iniciado! Importar√° a cada 6 horas.');
        }

        function stopAutoImport() {
            if (!isAutoImportRunning) {
                alert('Auto-import j√° est√° parado.');
                return;
            }
            
            isAutoImportRunning = false;
            clearInterval(autoImportInterval);
            autoImportInterval = null;
            
            updateRSSStatus('üî¥ Pausado', '#dc2626');
            localStorage.setItem('rss_auto_import_enabled', 'false');
            alert('‚è∏Ô∏è Auto-import pausado.');
        }

        async function forceRSSImport() {
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            if (!confirm('Importar RSS agora?')) return;
            
            await runAutoRSSImport();
        }

        function restoreAutoImport() {
            const wasEnabled = localStorage.getItem('rss_auto_import_enabled') === 'true';
            if (wasEnabled && currentSession) {
                console.log('Restaurando auto-import...');
                startAutoImport();
            }
        }

        // === MANUTEN√á√ÉO ===
        async function publicarTodasPendentes() {
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            if (!confirm('Publicar TODAS as not√≠cias pendentes?')) return;
            
            const statusEl = document.getElementById('maintenanceStatus');
            statusEl.classList.remove('hidden');
            statusEl.textContent = 'Publicando...';
            statusEl.style.color = '#ccc';
            
            try {
                const { count } = await supabaseClient
                    .from('noticias')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pendente');
                
                if (count === 0) {
                    statusEl.textContent = '‚úÖ Nenhuma pendente.';
                    statusEl.style.color = 'green';
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                    return;
                }
                
                const { error } = await supabaseClient
                    .from('noticias')
                    .update({ status: 'publicado' })
                    .eq('status', 'pendente');
                
                if (error) throw error;
                
                statusEl.textContent = `‚úÖ ${count} not√≠cias publicadas!`;
                statusEl.style.color = 'green';
                
                setTimeout(() => {
                    loadNoticias();
                    statusEl.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                statusEl.textContent = `‚ùå Erro: ${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        async function atualizarPrioridades() {
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            if (!confirm('Atualizar prioridades antigas para 1?')) return;
            
            const statusEl = document.getElementById('maintenanceStatus');
            statusEl.classList.remove('hidden');
            statusEl.textContent = 'Atualizando...';
            
            try {
                const { error } = await supabaseClient
                    .from('noticias')
                    .update({ prioridade: 1 })
                    .is('prioridade', null);
                
                if (error) throw error;
                
                statusEl.textContent = '‚úÖ Prioridades atualizadas!';
                statusEl.style.color = 'green';
                
                setTimeout(() => {
                    loadNoticias();
                    statusEl.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                statusEl.textContent = `‚ùå Erro: ${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        async function limparBanco() {
            if (!supabaseClient || !currentSession) {
                alert('Fa√ßa login primeiro!');
                return;
            }
            
            const confirmacao = prompt('Digite "DELETAR TUDO" para confirmar:');
            if (confirmacao !== 'DELETAR TUDO') {
                alert('Cancelado.');
                return;
            }
            
            const statusEl = document.getElementById('maintenanceStatus');
            statusEl.classList.remove('hidden');
            statusEl.textContent = 'Deletando...';
            statusEl.style.color = 'red';
            
            try {
                const { error } = await supabaseClient
                    .from('noticias')
                    .delete()
                    .neq('id', 0);
                
                if (error) throw error;
                
                statusEl.textContent = '‚úÖ Banco limpo!';
                statusEl.style.color = 'green';
                
                setTimeout(() => {
                    loadNoticias();
                    statusEl.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                statusEl.textContent = `‚ùå Erro: ${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        // === CARREGAR NOT√çCIAS ===
        async function loadNoticias() {
            const container = document.getElementById('noticias');
            container.innerHTML = '<div class="loading">Carregando...</div>';

            if (!supabaseClient) {
                container.innerHTML = '<div class="error-message">‚ùå Supabase n√£o configurado.</div>';
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('noticias')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="loading">‚úÖ Nenhuma not√≠cia publicada.</div>';
                    return;
                }

                container.innerHTML = data.map(noticia => {
                    const imagemHtml = noticia.image_url 
                        ? `<img src="${noticia.image_url}" alt="Imagem" class="noticia-image" onerror="this.style.display='none'">`
                        : '';
                    
                    const dataTexto = noticia.created_at ? new Date(noticia.created_at).toLocaleString('pt-BR') : '-';
                    
                    return `
                        <div class="noticia-card">
                            ${imagemHtml}
                            <div class="noticia-title">${noticia.title || '-'}</div>
                            <div class="noticia-content">${(noticia.content || '-').substring(0, 200)}...</div>
                            <div class="noticia-meta">
                                <strong>Categoria:</strong> ${noticia.category || '-'}<br>
                                <strong>Publicado:</strong> ${dataTexto}
                            </div>
                            <div class="noticia-actions">
                                <button onclick="editNoticia(${noticia.id})">‚úèÔ∏è Editar</button>
                                <button class="danger-button" onclick="deleteNoticia(${noticia.id})">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = `<div class="error-message">‚ùå ${error.message}</div>`;
            }
        }

        // === PUBLICAR MANUAL ===
        async function publishNoticia() {
            if (!supabaseClient) {
                alert('Configure o Supabase primeiro!');
                return;
            }

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const category = document.getElementById('category').value;
            const imageUrl = document.getElementById('manual-image').value;

            if (!title || !content) {
                alert('Preencha t√≠tulo e conte√∫do!');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('noticias')
                    .insert({
                        title: title,
                        content: content,
                        category: category,
                        image_url: imageUrl || null,
                        status: 'publicado',
                        prioridade: 1
                    });

                if (error) throw error;

                alert('‚úÖ Not√≠cia publicada!');
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                document.getElementById('manual-image').value = '';
                loadNoticias();

            } catch (error) {
                alert('‚ùå Erro: ' + error.message);
            }
        }

        // === EDITAR NOT√çCIA ===
        async function editNoticia(id) {
            if (!supabaseClient) {
                alert('Configure o Supabase primeiro!');
                return;
            }

            try {
                const { data: noticia, error } = await supabaseClient
                    .from('noticias')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;
                
                if (!noticia) {
                    alert('Not√≠cia n√£o encontrada!');
                    return;
                }

                document.getElementById('edit-title').value = noticia.title || '';
                document.getElementById('edit-content').value = noticia.content || '';
                document.getElementById('edit-category').value = noticia.category || 'Geral';
                document.getElementById('edit-image').value = noticia.image_url || '';

                currentEditingId = id;
                document.getElementById('editModal').classList.remove('hidden');

            } catch (error) {
                alert('‚ùå Erro ao carregar: ' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditingId = null;
        }

        async function saveEditedNoticia() {
            if (!supabaseClient || !currentEditingId) {
                alert('Erro: ID inv√°lido');
                return;
            }

            const title = document.getElementById('edit-title').value.trim();
            const content = document.getElementById('edit-content').value.trim();
            const category = document.getElementById('edit-category').value;
            const imageUrl = document.getElementById('edit-image').value.trim();

            if (!title || !content) {
                alert('‚ùå T√≠tulo e conte√∫do obrigat√≥rios!');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('noticias')
                    .update({
                        title: title,
                        content: content,
                        category: category,
                        image_url: imageUrl || null
                    })
                    .eq('id', currentEditingId);

                if (error) throw error;

                alert('‚úÖ Not√≠cia atualizada!');
                closeEditModal();
                loadNoticias();

            } catch (error) {
                alert('‚ùå Erro: ' + error.message);
            }
        }

        // === DELETAR ===
        async function deleteNoticia(id) {
            if (!confirm('Excluir esta not√≠cia?')) return;

            if (!supabaseClient) {
                alert('Configure o Supabase primeiro!');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('noticias')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('‚úÖ Not√≠cia exclu√≠da!');
                loadNoticias();
            } catch (error) {
                alert('‚ùå Erro: ' + error.message);
            }
        }

        // === FECHAR MODAL CLICANDO FORA ===
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('editModal');
            if (e.target === modal) {
                closeEditModal();
            }
        });

        // === INICIALIZA ===
        window.addEventListener('DOMContentLoaded', initSupabase);
    </script>
    







</body>



</html>