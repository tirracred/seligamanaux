<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SeligaManaux</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    
    <header class="site-header">
        <div class="header-container">
            <div class="logo">
                <a href="/"><h1>SeligaManaux (ADMIN)</h1></a>
            </div>

            
        </div>
    </header>
    
    <main class="container">

        <form id="login-form" class="admin-form">
            <h1 class="page-title-admin">Login do Administrador</h1>


            <div id="login-feedback-message" class="message" style="display: none;"></div>

            <div>
                <label for="admin-email">Email</label>
                <input type="email" id="admin-email" required>
            </div>

            <div>
                <label for="admin-password">Senha</label>
                <input type="password" id="admin-password" required>
            </div>

            <button type="submit" id="login-button">ENTRAR</button>
            <p id="loading-login" style="display: none; text-align: center; margin-top: 1rem; color: var(--texto-link);">Entrando...</p>
        </form>


        <form id="news-form" class="admin-form" style="display: none;">
            <h1 class="page-title-admin">Publicar Nova Notícia</h1>


            <div id="feedback-message" class="message" style="display: none;"></div>

            <div>
                <label for="news-title">Título</label>
                <input type="text" id="news-title" required>
            </div>
            
            <div>
                <label for="news-category">Categoria</label>
                <select id="news-category" required>
                    <option value="">Selecione...</option>
                    <option value="Manaus e Região">Manaus e Região</option>
                    <option value="Política">Política</option>
                    <option value="Esportes">Esportes</option>
                    <option value="Economia">Economia</option>
                    <option value="Geral">Geral</option>
                </select>
            </div>

            <div>
                <label for="news-headline-color">Cor da Manchete</label>
                <select id="news-headline-color" required>
                    <option value="blue">Azul (Padrão)</option>
                    <option value="red">Vermelho (Destaque)</option>
                </select>
            </div>

            <div>
                <label for="news-content">Conteúdo</label>
                <textarea id="news-content" rows="8" required></textarea>
            </div>

            <div>
                <label for="news-image">Anexar Foto Principal (Capa)</label>
                <input type="file" id="news-image" accept="image/*">
            </div>

            <div>
                <label for="news-gallery">Adicionar Galeria (até 10 mídias)</label>
                <input type="file" id="news-gallery" accept="image/*,video/*" multiple>
                <small style="color: var(--texto-secundario); margin-top: 5px; display: block;">
                    Segure Ctrl (ou Cmd) para selecionar múltiplos arquivos.
                </small>
            </div>
            
            <button type="submit" id="submit-button">PUBLICAR AGORA</button>
            <p id="loading-submit" style="display: none; text-align: center; margin-top: 1rem; color: var(--texto-link);">Publicando... Aguarde.</p>
        </form>



        <section id="manage-section" style="display: none;">
             <h1 class="page-title-admin">Gerenciar Notícias</h1>
             <p id="loading-manage" style="text-align: center; color: var(--texto-secundario);">Carregando notícias...</p>
             <div id="post-list-container">
                </div>
        </section>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- REFERÊNCIAS DOS ELEMENTOS ---
            const loginForm = document.getElementById('login-form');
            const newsForm = document.getElementById('news-form');
            const manageSection = document.getElementById('manage-section');
            const loginButton = document.getElementById('login-button');
            const loadingLogin = document.getElementById('loading-login');
            const loginFeedback = document.getElementById('login-feedback-message');
            


            const submitButton = document.getElementById('submit-button');
            const loadingSubmit = document.getElementById('loading-submit');
            const feedbackMessage = document.getElementById('feedback-message');
            
            const newsTitle = document.getElementById('news-title');
            const newsCategory = document.getElementById('news-category');
            const newsHeadlineColor = document.getElementById('news-headline-color');
            const newsContent = document.getElementById('news-content');
            const newsImageInput = document.getElementById('news-image');
            const newsGalleryInput = document.getElementById('news-gallery'); // Novo campo



            const loadingManage = document.getElementById('loading-manage');
            const postListContainer = document.getElementById('post-list-container');
            postListContainer.addEventListener('click', handleDeleteClick);

            // --- LÓGICA DE LOGIN ---
            loginForm.addEventListener('submit', handleLogin);

            async function handleLogin(event) {
                event.preventDefault();
                if (!supabase) return showLoginMessage('Erro: Supabase não inicializado', 'error');

                loginButton.disabled = true;
                loadingLogin.style.display = 'block';
                loginFeedback.style.display = 'none';

                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });

                    if (error) throw error;



                    loginForm.style.display = 'none';
                    newsForm.style.display = 'block';
                    manageSection.style.display = 'block';


                    



                    await loadManagedPosts();

                } catch (err) {
                    console.error("Erro de login:", err);
                    showLoginMessage(`Erro: ${err.message}`, 'error');
                } finally {
                    loginButton.disabled = false;
                    loadingLogin.style.display = 'none';
                }
            }


            // --- LÓGICA DE PUBLICAÇÃO DE NOTÍCIAS ---
            newsForm.addEventListener('submit', handleFormSubmit);

            async function handleFormSubmit(event) {
                event.preventDefault();
                
                if (!supabase) {
                    showMessage('Erro: Falha na conexão com o banco de dados.', 'error');
                    return;
                }
                
                submitButton.disabled = true;
                loadingSubmit.style.display = 'block';
                feedbackMessage.style.display = 'none';

                try {
                    // 1. Upload da Imagem Principal (Capa)
                    const mainImageFile = newsImageInput.files[0];
                    let mainImageUrl = null;
                    if (mainImageFile) {
                        mainImageUrl = await uploadMedia(mainImageFile);
                    }

                    // 2. Upload da Galeria (ATUALIZADO)
                    const galleryFiles = Array.from(newsGalleryInput.files).slice(0, 10); // Limita a 10 arquivos
                    let galleryUrls = [];
                    if (galleryFiles.length > 0) {
                        // Faz o upload de todos os arquivos da galeria em paralelo
                        const uploadPromises = galleryFiles.map(file => uploadMedia(file));
                        galleryUrls = await Promise.all(uploadPromises);
                    }

                    // 3. Monta o objeto da notícia
                    const newPost = {
                        title: newsTitle.value,
                        content: newsContent.value,
                        category: newsCategory.value,
                        image_url: mainImageUrl, // URL da imagem principal
                        headline_color: newsHeadlineColor.value,
                        gallery_urls: galleryUrls.length > 0 ? galleryUrls : null // Salva o array de URLs
                    };

                    // 4. Insere no banco de dados
                    const { error } = await supabase
                        .from(DB_TABLE)
                        .insert(newPost);

                    if (error) throw error;

                    showMessage('Sucesso! Notícia publicada.', 'success');
                    newsForm.reset();
                    


                    await loadManagedPosts();

                } catch (err) {
                    console.error("Erro ao publicar:", err);
                    if (err.message.includes("permission denied")) {
                         showMessage('Erro: Você não tem permissão para publicar. Verifique as regras RLS no Supabase.', 'error');
                    } else {
                         showMessage(`Erro: ${err.message}`, 'error');
                    }
                } finally {
                    submitButton.disabled = false;
                    loadingSubmit.style.display = 'none';
                }
            }

            // Função auxiliar de Upload (não mudou)
            async function uploadMedia(file) {
                if (!file) return null;
                const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`; // Limpa o nome do arquivo
                
                const { data, error } = await supabase.storage
                    .from(STORAGE_BUCKET)
                    .upload(fileName, file);

                if (error) throw new Error(`Erro no upload: ${error.message}`);
                
                const { data: publicUrlData } = supabase.storage
                    .from(STORAGE_BUCKET)
                    .getPublicUrl(data.path);
                    
                return publicUrlData.publicUrl;
            }

            // --- FUNÇÕES DE GERENCIAMENTO (COM CORREÇÃO DO BOTÃO APAGAR) ---

            async function loadManagedPosts() {
                loadingManage.style.display = 'block';
                postListContainer.innerHTML = '';

                if (!supabase) return;

                const { data: posts, error } = await supabase
                    .from(DB_TABLE)
                    .select('id, title, created_at')
                    .order('created_at', { ascending: false });
                
                loadingManage.style.display = 'none';

                if (error) {
                    console.error("Erro ao carregar posts:", error);
                    postListContainer.innerHTML = `<p style="color: red; padding: 1rem;">Erro ao carregar posts.</p>`;
                    return;
                }

                if (posts.length === 0) {
                     postListContainer.innerHTML = `<p style="color: var(--texto-secundario); padding: 1rem;">Nenhum post publicado.</p>`;
                     return;
                }

                posts.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'post-item';
                    postEl.innerHTML = `
                        <span>${post.title}</span>
                        <button class="delete-post-btn" data-id="${post.id}">Apagar</button>
                    `;
                    postListContainer.appendChild(postEl);
                });
            }

            async function handleDeleteClick(event) {
                if (!event.target.classList.contains('delete-post-btn')) return;

                const button = event.target;
                const postId = button.dataset.id;
                
                if (!confirm("Tem certeza que deseja apagar este post? Esta ação não pode ser desfeita.")) {
                    return;
                }

                button.disabled = true;
                button.innerText = 'Apagando...';

                try {
                    // *** CORREÇÃO APLICADA AQUI ***
                    // O erro de digitação `error }_` foi removido.
                    const { error } = await supabase
                        .from(DB_TABLE)
                        .delete()
                        .eq('id', postId);
                    
                    if (error) {
                        // Se o erro for de RLS (permissão negada), avisa o usuário.
                        if (error.message.includes("permission denied")) {
                            throw new Error("Permissão negada. Verifique as regras RLS (DELETE) no Supabase.");
                        }
                        throw error;
                    }

                    button.closest('.post-item').remove();
                    showMessage('Post apagado com sucesso.', 'success');

                } catch (err) {
                    console.error("Erro ao apagar:", err);
                    showMessage(`Erro ao apagar: ${err.message}`, 'error');
                    button.disabled = false;
                    button.innerText = 'Apagar';
                }
            }


            // --- Funções de Feedback ---
            function showMessage(text, type) {
                feedbackMessage.innerText = text;
                feedbackMessage.className = `message ${type}`;
                feedbackMessage.style.display = 'block';


                setTimeout(() => { feedbackMessage.style.display = 'none'; }, 3000);
            }
            
            function showLoginMessage(text, type) {
                loginFeedback.innerText = text;
                loginFeedback.className = `message ${type}`;
                loginFeedback.style.display = 'block';
            }
        });

   
   </script>






</body>








</html>


