<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Se Liga Manaux</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            margin-bottom: 40px;
            color: #dc2626;
            font-size: 2.5em;
            text-shadow: 0 2px 20px rgba(220, 38, 38, 0.4);
        }

        h2 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid #dc2626;
            padding-bottom: 10px;
        }

        h3 {
            color: #ccc;
            margin: 25px 0 15px;
            font-size: 1.3em;
        }

        .auth-section, .admin-section, .scraped-section, .rss-section, .scrape-section {
            background: rgba(38, 38, 38, 0.95);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .scraped-section {
            background: rgba(31, 41, 55, 0.95);
            border: 2px solid #059669;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.2);
        }

        .rss-section {
            background: rgba(31, 41, 55, 0.95);
            border: 2px solid #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }

        .scrape-section {
            background: rgba(31, 41, 55, 0.95);
            border: 2px solid #f59e0b;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
        }

        input, textarea, button, select {
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            border: 1px solid #404040;
            background: #2a2a2a;
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #dc2626;
            background: #333;
        }

        textarea {
            min-height: 180px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
        }

        button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .scrape-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .scrape-button:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .rss-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .rss-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-aprovar {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            padding: 12px 20px;
            margin: 5px;
            width: auto;
            display: inline-block;
            font-size: 13px;
        }

        .btn-aprovar:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
        }

        .btn-deletar {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 12px 20px;
            margin: 5px;
            width: auto;
            display: inline-block;
            font-size: 13px;
        }

        .btn-deletar:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        .btn-publicar {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 12px 20px;
            margin: 5px;
            width: auto;
            display: inline-block;
            font-size: 13px;
        }

        .btn-publicar:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .news-item {
            background: rgba(26, 26, 26, 0.95);
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            border-left: 5px solid #dc2626;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .news-item:hover {
            background: rgba(34, 34, 34, 0.95);
            border-left-color: #f87171;
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .news-item h3 {
            margin-bottom: 15px;
            font-size: 1.4em;
            line-height: 1.4;
        }

        .news-item p {
            color: #bbb;
            line-height: 1.8;
            margin: 12px 0;
        }

        .news-item img {
            max-width: 300px;
            border-radius: 8px;
            margin: 15px 0;
            display: block;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .news-item video {
            max-width: 300px;
            border-radius: 8px;
            margin: 15px 0;
            display: block;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .badge-legenda {
            display: inline-block;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
            margin-right: 12px;
            margin-bottom: 12px;
        }

        .auto-toggle {
            background: rgba(42, 42, 42, 0.95);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #404040;
        }

        .auto-toggle label {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .auto-toggle input[type="checkbox"] {
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .auto-toggle .hint {
            font-size: 13px;
            color: #888;
            margin-top: 12px;
            line-height: 1.6;
        }

        .hidden { display: none; }

        .error {
            background: rgba(127, 29, 29, 0.95);
            color: #fecaca;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #dc2626;
        }

        .success {
            background: rgba(6, 95, 70, 0.95);
            color: #d1fae5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #059669;
        }

        .warning {
            background: rgba(120, 53, 15, 0.95);
            color: #fde68a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #f59e0b;
        }

        #scraped-list, #published-list, #scrape-result, #rss-result {
            margin-top: 30px;
        }

        .portal-config {
            background: rgba(42, 42, 42, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #404040;
        }

        .portal-config label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .portal-config input {
            margin: 8px 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1024px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .news-item img, .news-item video { max-width: 100%; }
            h1 { font-size: 2em; }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(42, 42, 42, 0.95);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #404040;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #dc2626;
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.2);
        }

        .stat-card h4 {
            color: #888;
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 38px;
            font-weight: bold;
            color: #dc2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 16px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¥ Admin - Se Liga Manaux</h1>

        <!-- Se√ß√£o de Autentica√ß√£o -->
        <div id="auth-section" class="auth-section">
            <h2>üîê Login do Administrador</h2>
            <p style="color: #888; margin-bottom: 20px;">
                Se voc√™ est√° vendo erro "Invalid API key", precisa atualizar as keys do Supabase no c√≥digo abaixo.
            </p>
            <input type="email" id="email" placeholder="Email do administrador">
            <input type="password" id="password" placeholder="Senha">
            <button onclick="login()">Entrar no Painel</button>
        </div>

        <!-- Se√ß√£o do Admin -->
        <div id="admin-section" class="admin-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h2>üë§ Painel do Administrador</h2>
                    <p style="color: #888;">Usu√°rio logado: <strong id="user-email" style="color: #dc2626;"></strong></p>
                </div>
                <button onclick="logout()" style="width: auto; padding: 12px 30px;">Sair</button>
            </div>

            <!-- Estat√≠sticas -->
            <div class="stats">
                <div class="stat-card">
                    <h4>Publicadas</h4>
                    <div class="value" id="stat-publicadas">0</div>
                </div>
                <div class="stat-card">
                    <h4>Pendentes</h4>
                    <div class="value" id="stat-pendentes" style="color: #f59e0b;">0</div>
                </div>
                <div class="stat-card">
                    <h4>Total</h4>
                    <div class="value" id="stat-total" style="color: #3b82f6;">0</div>
                </div>
            </div>

            <!-- Publicar Not√≠cia Manual -->
            <h3>üìù Publicar Not√≠cia Manualmente</h3>
            <input type="text" id="title" placeholder="T√≠tulo da not√≠cia">
            <textarea id="content" rows="10" placeholder="Conte√∫do completo da not√≠cia"></textarea>
            <input type="text" id="category" placeholder="Categoria/Legenda (ex: Crime, Pol√≠tica, Esporte)">
            <input type="text" id="image_url" placeholder="URL da Imagem (opcional)">
            <input type="text" id="headline_color" placeholder="Cor do T√≠tulo (#e53e3e vermelho ou #059669 azul)" value="#059669">
            <input type="text" id="videos" placeholder="URL do V√≠deo (opcional)">
            <button onclick="publishNews()">üì¢ Publicar Agora</button>

            <!-- Not√≠cias Publicadas -->
            <h3>üì∞ Not√≠cias Publicadas</h3>
            <button onclick="loadPublishedNews()" style="width: auto; padding: 12px 25px;">üîÑ Atualizar Lista</button>
            <div id="published-list"></div>
        </div>

        <!-- Se√ß√£o RSS Importer -->
        <div id="rss-section" class="rss-section hidden">
            <h2>üì° RSS Importer Autom√°tico</h2>
            <p style="color: #aaa; margin-bottom: 20px;">
                Importar e reescrever not√≠cias automaticamente dos feeds RSS de Manaus/Amazonas usando IA.
            </p>

            <!-- Toggle de Automa√ß√£o -->
            <div class="auto-toggle">
                <label>
                    <input type="checkbox" id="rssAutoMode" onchange="toggleAutoMode()">
                    <div>
                        <strong style="font-size: 16px;">Modo Autom√°tico de Publica√ß√£o</strong>
                        <p class="hint">
                            ‚úÖ <strong>Ativado:</strong> Not√≠cias s√£o publicadas automaticamente<br>
                            ‚ö†Ô∏è <strong>Desativado:</strong> Not√≠cias ficam pendentes para aprova√ß√£o manual
                        </p>
                    </div>
                </label>
            </div>

            <button class="rss-button" onclick="importarRSS()">üöÄ Importar do RSS Agora</button>
            <div id="rss-result"></div>
        </div>

        <!-- Se√ß√£o Web Scraping -->
        <div id="scrape-section" class="scrape-section hidden">
            <h2>üï∑Ô∏è Web Scraping de Portais</h2>
            <p style="color: #aaa; margin-bottom: 20px;">
                Buscar, reescrever e salvar not√≠cias dos principais portais de Manaus/Amazonas.
            </p>

            <button class="scrape-button" onclick="scrapeAndRewrite()">üîç Iniciar Scraping</button>
            <div id="scrape-result"></div>
        </div>

        <!-- Se√ß√£o de Not√≠cias Pendentes -->
        <div id="scraped-section" class="scraped-section hidden">
            <h2>üìã Not√≠cias Pendentes de Aprova√ß√£o</h2>
            <p style="color: #aaa; margin-bottom: 20px;">
                Not√≠cias coletadas automaticamente que est√£o aguardando publica√ß√£o manual.
            </p>
            <button onclick="loadPendingNews()" style="width: auto; padding: 12px 25px;">üîÑ Atualizar Lista</button>
            <div id="scraped-list"></div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURA√á√ÉO SUPABASE
        // V√° no Supabase Dashboard > Settings > API e copie as keys aqui:
        // =====================================================
        const SUPABASE_URL = 'SUA_URL_AQUI';
        const SUPABASE_ANON_KEY = 'SUA_ANON_KEY_AQUI';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        // =====================================================
        // AUTENTICA√á√ÉO
        // =====================================================
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                alert('‚ùå Preencha email e senha!');
                return;
            }

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                alert('‚ùå Erro no login: ' + error.message);
                return;
            }

            currentUser = data.user;
            document.getElementById('user-email').textContent = currentUser.email;
            
            // Mostrar se√ß√µes
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('rss-section').classList.remove('hidden');
            document.getElementById('scrape-section').classList.remove('hidden');
            document.getElementById('scraped-section').classList.remove('hidden');

            // Carregar dados
            loadPublishedNews();
            loadPendingNews();
            loadStats();
            loadAutoModeState();
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('rss-section').classList.add('hidden');
            document.getElementById('scrape-section').classList.add('hidden');
            document.getElementById('scraped-section').classList.add('hidden');
        }

        // =====================================================
        // ESTAT√çSTICAS
        // =====================================================
        async function loadStats() {
            try {
                const { data: publicadas } = await supabaseClient
                    .from('noticias')
                    .select('id', { count: 'exact', head: true })
                    .eq('status', 'publicado');

                const { data: pendentes } = await supabaseClient
                    .from('noticias')
                    .select('id', { count: 'exact', head: true })
                    .eq('status', 'pendente');

                const { data: total } = await supabaseClient
                    .from('noticias')
                    .select('id', { count: 'exact', head: true });

                document.getElementById('stat-publicadas').textContent = publicadas?.length || 0;
                document.getElementById('stat-pendentes').textContent = pendentes?.length || 0;
                document.getElementById('stat-total').textContent = total?.length || 0;
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // =====================================================
        // PUBLICAR NOT√çCIA MANUAL
        // =====================================================
        async function publishNews() {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const category = document.getElementById('category').value.trim();
            const image_url = document.getElementById('image_url').value.trim();
            const headline_colo = document.getElementById('headline_color').value.trim();
            const videos = document.getElementById('videos').value.trim();

            if (!title || !content) {
                alert('‚ùå T√≠tulo e conte√∫do s√£o obrigat√≥rios!');
                return;
            }

            const { error } = await supabaseClient.from('noticias').insert({
                title,
                content,
                category: category || 'Not√≠cia',
                image_url: image_url || null,
                headline_colo: headline_colo || '#059669',
                videos: videos || null,
                status: 'publicado',
                created_at: new Date().toISOString()
            });

            if (error) {
                alert('‚ùå Erro ao publicar: ' + error.message);
                return;
            }

            alert('‚úÖ Not√≠cia publicada com sucesso!');
            
            // Limpar formul√°rio
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('category').value = '';
            document.getElementById('image_url').value = '';
            document.getElementById('videos').value = '';
            document.getElementById('headline_color').value = '#059669';
            
            loadPublishedNews();
            loadStats();
        }

        // =====================================================
        // CARREGAR NOT√çCIAS PUBLICADAS
        // =====================================================
        async function loadPublishedNews() {
            const container = document.getElementById('published-list');
            container.innerHTML = '<div class="loading">Carregando</div>';

            try {
                const { data: noticias, error } = await supabaseClient
                    .from('noticias')
                    .select('*')
                    .eq('status', 'publicado')
                    .order('created_at', { ascending: false })
                    .limit(15);

                if (error) throw error;

                if (!noticias || noticias.length === 0) {
                    container.innerHTML = '<p style="color: #888; padding: 20px;">Nenhuma not√≠cia publicada.</p>';
                    return;
                }

                container.innerHTML = noticias.map(n => `
                    <div class="news-item">
                        <span class="badge-legenda">${n.category || 'Not√≠cia'}</span>
                        <h3 style="color: ${n.headline_colo || '#059669'}">${n.title}</h3>
                        ${n.image_url ? `<img src="${n.image_url}" alt="${n.title}" onerror="this.style.display='none'">` : ''}
                        ${n.videos ? `<video controls><source src="${n.videos}" type="video/mp4"></video>` : ''}
                        <p>${n.content.substring(0, 200)}...</p>
                        <p style="font-size: 12px; color: #666;">
                            üìÖ ${new Date(n.created_at).toLocaleString('pt-BR')}
                        </p>
                        <button class="btn-deletar" onclick="deleteNews(${n.id})">üóëÔ∏è Deletar</button>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        // =====================================================
        // CARREGAR NOT√çCIAS PENDENTES
        // =====================================================
        async function loadPendingNews() {
            const container = document.getElementById('scraped-list');
            container.innerHTML = '<div class="loading">Carregando</div>';

            try {
                const { data: noticias, error } = await supabaseClient
                    .from('noticias')
                    .select('*')
                    .eq('status', 'pendente')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!noticias || noticias.length === 0) {
                    container.innerHTML = '<p style="color: #888; padding: 20px;">‚úÖ Nenhuma not√≠cia pendente. Tudo aprovado!</p>';
                    return;
                }

                container.innerHTML = noticias.map(n => `
                    <div class="news-item">
                        <span class="badge-legenda">${n.category || 'Pendente'}</span>
                        <h3 style="color: ${n.headline_colo || '#059669'}">${n.title}</h3>
                        ${n.image_url ? `<img src="${n.image_url}" alt="${n.title}" onerror="this.style.display='none'">` : ''}
                        ${n.videos ? `<video controls><source src="${n.videos}" type="video/mp4"></video>` : ''}
                        <p>${n.content.substring(0, 250)}...</p>
                        <p style="font-size: 12px; color: #666;">
                            üìÖ Importado em: ${new Date(n.created_at).toLocaleString('pt-BR')}
                        </p>
                        <div style="margin-top: 15px;">
                            <button class="btn-aprovar" onclick="aprovarNoticia(${n.id})">
                                ‚úÖ Aprovar e Publicar
                            </button>
                            <button class="btn-deletar" onclick="deleteNews(${n.id})">
                                ‚ùå Rejeitar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        // =====================================================
        // APROVAR NOT√çCIA
        // =====================================================
        async function aprovarNoticia(id) {
            if (!confirm('‚úÖ Aprovar e publicar esta not√≠cia?')) return;

            const { error } = await supabaseClient
                .from('noticias')
                .update({ status: 'publicado' })
                .eq('id', id);

            if (error) {
                alert('‚ùå Erro ao aprovar: ' + error.message);
                return;
            }

            alert('‚úÖ Not√≠cia aprovada e publicada com sucesso!');
            loadPendingNews();
            loadPublishedNews();
            loadStats();
        }

        // =====================================================
        // DELETAR NOT√çCIA
        // =====================================================
        async function deleteNews(id) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja deletar esta not√≠cia?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) return;

            const { error } = await supabaseClient
                .from('noticias')
                .delete()
                .eq('id', id);

            if (error) {
                alert('‚ùå Erro ao deletar: ' + error.message);
                return;
            }

            alert('‚úÖ Not√≠cia deletada com sucesso!');
            loadPendingNews();
            loadPublishedNews();
            loadStats();
        }

        // =====================================================
        // IMPORTAR RSS
        // =====================================================
        async function importarRSS() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Importando... Isso pode levar alguns minutos';

            const resultDiv = document.getElementById('rss-result');
            resultDiv.innerHTML = '<div class="warning">‚è≥ Aguarde, processando feeds RSS e reescrevendo com IA...</div>';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/rss_import`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro desconhecido');
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Importa√ß√£o RSS Conclu√≠da!</h3>
                        <div style="margin-top: 15px;">
                            <p><strong>üìä Artigos Processados:</strong> ${result.processed}</p>
                            <p><strong>‚úÖ Artigos Importados:</strong> ${result.imported}</p>
                            <p><strong>‚ùå Erros:</strong> ${result.errors}</p>
                            <p><strong>‚è±Ô∏è Tempo Total:</strong> ${result.duration}</p>
                            <p><strong>ü§ñ Modo:</strong> ${result.mode === 'autom√°tico' ? '‚úÖ Autom√°tico (publicado direto)' : '‚ö†Ô∏è Manual (pendente de aprova√ß√£o)'}</p>
                        </div>
                    </div>
                `;

                loadPendingNews();
                loadPublishedNews();
                loadStats();
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro na Importa√ß√£o RSS</strong><br><br>
                        ${error.message}<br><br>
                        <small>Verifique se a Edge Function 'rss_import' est√° deployada e funcionando.</small>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // =====================================================
        // WEB SCRAPING
        // =====================================================
        async function scrapeAndRewrite() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Fazendo scraping... Pode levar alguns minutos';

            const resultDiv = document.getElementById('scrape-result');
            resultDiv.innerHTML = '<div class="warning">‚è≥ Buscando not√≠cias nos portais e reescrevendo com IA...</div>';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/scrape-and-rewrite-with-groq`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro desconhecido');
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Scraping Conclu√≠do!</h3>
                        <div style="margin-top: 15px;">
                            <p><strong>üìä Total Processado:</strong> ${result.total || 0}</p>
                            <p><strong>‚úÖ Importados:</strong> ${result.saved || 0}</p>
                            <p><strong>‚ùå Erros:</strong> ${result.errors || 0}</p>
                        </div>
                    </div>
                `;

                loadPendingNews();
                loadPublishedNews();
                loadStats();
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro no Scraping</strong><br><br>
                        ${error.message}<br><br>
                        <small>Verifique se a Edge Function 'scrape-and-rewrite-with-groq' est√° deployada.</small>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // =====================================================
        // TOGGLE MODO AUTOM√ÅTICO
        // =====================================================
        function toggleAutoMode() {
            const checkbox = document.getElementById('rssAutoMode');
            const isAuto = checkbox.checked;

            localStorage.setItem('RSS_IMPORT_AUTO', isAuto);

            alert(
                `${isAuto ? '‚úÖ' : '‚ö†Ô∏è'} Modo ${isAuto ? 'AUTOM√ÅTICO' : 'MANUAL'} ativado!\n\n` +
                `${isAuto 
                    ? '‚úì As pr√≥ximas importa√ß√µes RSS ser√£o publicadas automaticamente.' 
                    : '‚äó As pr√≥ximas importa√ß√µes RSS ficar√£o pendentes de aprova√ß√£o.'
                }\n\n` +
                `üìù NOTA IMPORTANTE:\n` +
                `Para que esta configura√ß√£o funcione no servidor, voc√™ precisa definir a vari√°vel de ambiente:\n` +
                `RSS_IMPORT_AUTO=${isAuto}\n\n` +
                `no Supabase Dashboard > Edge Functions > Settings > Secrets`
            );
        }

        function loadAutoModeState() {
            const saved = localStorage.getItem('RSS_IMPORT_AUTO') === 'true';
            const checkbox = document.getElementById('rssAutoMode');
            if (checkbox) {
                checkbox.checked = saved;
            }
        }

        // =====================================================
        // INICIALIZA√á√ÉO
        // =====================================================
        window.addEventListener('DOMContentLoaded', async () => {
            // Verificar se j√° est√° logado
            const { data } = await supabaseClient.auth.getSession();
            
            if (data.session) {
                currentUser = data.session.user;
                document.getElementById('user-email').textContent = currentUser.email;
                
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('admin-section').classList.remove('hidden');
                document.getElementById('rss-section').classList.remove('hidden');
                document.getElementById('scrape-section').classList.remove('hidden');
                document.getElementById('scraped-section').classList.remove('hidden');
                
                loadPublishedNews();
                loadPendingNews();
                loadStats();
                loadAutoModeState();
            }
        });

        // Auto-refresh a cada 2 minutos
        setInterval(() => {
            if (currentUser) {
                loadStats();
            }
        }, 120000);
    </script>
</body>
</html>